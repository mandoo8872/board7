import{r as o,j as n}from"./index-CN418Rqv.js";import{a as ie,u as te,b as oe,C as se}from"./Canvas-Bc7J0V62.js";const re=()=>{var k,F,U,q,Z;const{currentTool:e,setCurrentTool:c,fitToWindow:u,setSelectedObjectId:p}=ie(),{addTextObject:w,settings:a}=te(),{penColor:d,penWidth:E,setPenColor:s,setPenWidth:r}=oe(),h=["#000000","#ff0000","#0000ff","#ffff00","#ffffff"],l=(()=>{try{const t=localStorage.getItem("viewFloatingToolbar_position"),x=localStorage.getItem("viewFloatingToolbar_size"),I={x:window.innerWidth-200,y:window.innerHeight-150},A={width:180,height:120};return{position:t?JSON.parse(t):I,size:x?JSON.parse(x):A}}catch{return{position:{x:window.innerWidth-200,y:window.innerHeight-150},size:{width:180,height:120}}}})(),[y,b]=o.useState(l.position),[C,S]=o.useState(l.size);o.useEffect(()=>{const t=g(l.position,l.size);(t.x!==l.position.x||t.y!==l.position.y)&&(b(t),O(t,l.size))},[]);const[P,v]=o.useState(!1),[N,m]=o.useState(!1),[j,L]=o.useState({x:0,y:0}),[$,D]=o.useState(!1),T=o.useRef(null),O=(t,x)=>{try{localStorage.setItem("viewFloatingToolbar_position",JSON.stringify(t)),localStorage.setItem("viewFloatingToolbar_size",JSON.stringify(x))}catch(I){console.warn("Failed to save toolbar settings:",I)}},g=(t,x)=>{const A=x.width*.2,H=x.height*.2,R=window.innerWidth-A,G=window.innerHeight-H,Y=-x.width+A,Q=-x.height+H;return{x:Math.max(Y,Math.min(R,t.x)),y:Math.max(Q,Math.min(G,t.y))}},z={admin:{objectCreationPosition:((k=a==null?void 0:a.admin)==null?void 0:k.objectCreationPosition)??{x:200,y:200},defaultBoxWidth:((F=a==null?void 0:a.admin)==null?void 0:F.defaultBoxWidth)??200,defaultBoxHeight:((U=a==null?void 0:a.admin)==null?void 0:U.defaultBoxHeight)??60,defaultFontSize:((q=a==null?void 0:a.admin)==null?void 0:q.defaultFontSize)??18,defaultCheckboxSettings:((Z=a==null?void 0:a.admin)==null?void 0:Z.defaultCheckboxSettings)??{checkedColor:"#22c55e",uncheckedColor:"#f3f4f6",checkedBackgroundColor:"#22c55e",uncheckedBackgroundColor:"#f3f4f6",checkedBackgroundOpacity:.2,uncheckedBackgroundOpacity:.1}}};o.useEffect(()=>{if(!P&&!N)return;const t=I=>{var A;if(P){const H={x:I.clientX-j.x,y:I.clientY-j.y},R=g(H,C);b(R)}if(N){const H=(A=T.current)==null?void 0:A.getBoundingClientRect();if(H){const R=Math.max(120,I.clientX-H.left),G=Math.max(80,I.clientY-H.top),Y={width:R,height:G},Q=g(y,Y);S(Y),b(Q)}}},x=I=>{if((P||N)&&O(y,C),v(!1),m(!1),T.current)try{T.current.releasePointerCapture(I.pointerId)}catch{}};return document.addEventListener("pointermove",t),document.addEventListener("pointerup",x),()=>{document.removeEventListener("pointermove",t),document.removeEventListener("pointerup",x)}},[P,N,j]),o.useEffect(()=>{const t=()=>{const x=g(y,C);(x.x!==y.x||x.y!==y.y)&&(b(x),O(x,C))};return window.addEventListener("resize",t),()=>window.removeEventListener("resize",t)},[y,C]);const W=t=>{var A;const x=t.target;if(x.closest("button")||x.closest(".resize-handle"))return;t.preventDefault(),t.stopPropagation(),v(!0);try{t.currentTarget.setPointerCapture(t.pointerId)}catch{}const I=(A=T.current)==null?void 0:A.getBoundingClientRect();I&&L({x:t.clientX-I.left,y:t.clientY-I.top})},X=t=>{t.preventDefault(),t.stopPropagation(),m(!0);try{t.currentTarget.setPointerCapture(t.pointerId)}catch{}},K=t=>{c(t),t!=="pen"&&D(!1)},_=async()=>{const{x:t,y:x}=z.admin.objectCreationPosition,{checkedColor:I,uncheckedColor:A,checkedBackgroundColor:H,uncheckedBackgroundColor:R,checkedBackgroundOpacity:G,uncheckedBackgroundOpacity:Y}=z.admin.defaultCheckboxSettings,Q={x:t,y:x,width:z.admin.defaultBoxWidth,height:z.admin.defaultBoxHeight,text:"새 체크박스",hasCheckbox:!0,checkboxChecked:!1,checkboxCheckedColor:I,checkboxUncheckedColor:A,checkedBackgroundColor:H,uncheckedBackgroundColor:R,checkedBackgroundOpacity:G,uncheckedBackgroundOpacity:Y,boxStyle:{backgroundColor:"#ffffff",backgroundOpacity:1,borderColor:"#000000",borderWidth:1,borderRadius:8},fontSize:z.admin.defaultFontSize,textStyle:{color:"#000000",fontFamily:"Arial, sans-serif",bold:!1,italic:!1,horizontalAlign:"left",verticalAlign:"middle"},permissions:{movable:!0,resizable:!0,deletable:!0},zIndex:Date.now(),locked:!1,visible:!0,opacity:1,isEditing:!0,lastModified:Date.now()};try{const ee=await w(Q);p(ee),setTimeout(()=>{window.dispatchEvent(new CustomEvent("activateVirtualKeyboard",{detail:{objectId:ee}}))},100)}catch(ee){console.error("❌ 체크박스 생성 실패:",ee)}},J=t=>{s(t),D(!1)},B=t=>{const x=Math.max(1,Math.min(20,E+t));r(x)},ne=Math.min(C.width/180,C.height/120),M=Math.max(24,Math.min(40,32*ne)),i=M+8;return n.jsxs("div",{ref:T,"data-floating-toolbar":"true",className:"fixed bg-white bg-opacity-95 rounded-lg shadow-2xl border border-gray-300 select-none cursor-move",style:{left:y.x,top:y.y,width:C.width,height:C.height,zIndex:9999,minWidth:120,minHeight:80,touchAction:"none"},onPointerDown:W,onClick:t=>t.stopPropagation(),children:[n.jsxs("div",{className:"p-2 h-full flex flex-col",children:[n.jsxs("div",{className:"flex flex-wrap gap-1 flex-1 content-start",style:{minHeight:i},children:[n.jsx("button",{onClick:t=>{t.stopPropagation(),K("select")},className:`rounded transition-all duration-200 flex items-center justify-center ${e==="select"?"bg-blue-500 text-white shadow-md":"bg-gray-100 text-gray-700 hover:bg-gray-200"}`,style:{width:i,height:i},title:"선택 도구",children:n.jsx("span",{style:{fontSize:M*.6},children:"👆"})}),n.jsx("button",{onClick:t=>{t.stopPropagation(),K("pen")},className:`rounded transition-all duration-200 flex items-center justify-center ${e==="pen"?"bg-blue-500 text-white shadow-md":"bg-gray-100 text-gray-700 hover:bg-gray-200"}`,style:{width:i,height:i},title:"필기 도구",children:n.jsx("span",{style:{fontSize:M*.6},children:"✏️"})}),n.jsx("button",{onClick:t=>{t.stopPropagation(),K("eraser")},className:`rounded transition-all duration-200 flex items-center justify-center ${e==="eraser"?"bg-blue-500 text-white shadow-md":"bg-gray-100 text-gray-700 hover:bg-gray-200"}`,style:{width:i,height:i},title:"지우개",children:n.jsx("span",{style:{fontSize:M*.6},children:"🧽"})}),n.jsx("button",{onClick:t=>{t.stopPropagation(),_()},className:"rounded transition-all duration-200 flex items-center justify-center bg-green-500 text-white hover:bg-green-600 shadow-md",style:{width:i,height:i},title:"체크박스 추가",children:n.jsx("span",{style:{fontSize:M*.6},children:"☑️"})}),n.jsx("button",{onClick:t=>{t.stopPropagation(),u()},className:"rounded transition-all duration-200 flex items-center justify-center bg-blue-500 text-white hover:bg-blue-600 shadow-md",style:{width:i,height:i},title:"창맞춤",children:n.jsx("span",{style:{fontSize:M*.6},children:"⌂"})}),e==="pen"&&n.jsxs(n.Fragment,{children:[n.jsx("button",{onClick:t=>{t.stopPropagation(),D(!$)},className:"rounded border flex items-center justify-center bg-white hover:bg-gray-50",style:{width:i,height:i},title:"색상 선택",children:n.jsx("div",{className:"rounded",style:{backgroundColor:d,width:M*.6,height:M*.6,border:"1px solid #ccc"}})}),n.jsx("button",{onClick:t=>{t.stopPropagation(),B(1)},className:"rounded bg-gray-100 hover:bg-gray-200 flex items-center justify-center",style:{width:i,height:i},title:"굵기 증가",children:n.jsx("span",{style:{fontSize:M*.5},children:"▲"})}),n.jsx("button",{onClick:t=>{t.stopPropagation(),B(-1)},className:"rounded bg-gray-100 hover:bg-gray-200 flex items-center justify-center",style:{width:i,height:i},title:"굵기 감소",children:n.jsx("span",{style:{fontSize:M*.5},children:"▼"})})]})]}),$&&e==="pen"&&n.jsx("div",{className:"mt-2 p-2 bg-gray-50 rounded border-t",children:n.jsx("div",{className:"flex flex-wrap gap-1 justify-center",children:h.map(t=>n.jsx("button",{onClick:x=>{x.stopPropagation(),J(t)},className:"rounded border-2 hover:scale-110 transition-transform",style:{backgroundColor:t,borderColor:d===t?"#000":"#ccc",width:Math.max(20,M*.6),height:Math.max(20,M*.6)},title:t},t))})})]}),n.jsx("div",{className:"resize-handle absolute bottom-0 right-0 w-4 h-4 cursor-se-resize",style:{touchAction:"none"},onPointerDown:X,onClick:t=>t.stopPropagation(),children:n.jsx("div",{className:"absolute bottom-1 right-1 w-2 h-2 border-r-2 border-b-2 border-gray-400"})})]})},ae=({isKorean:e,isShiftPressed:c,onKeyPress:u,onShiftPress:p,onLanguageToggle:w,keyboardWidth:a,keyboardHeight:d})=>{const E={row1:["ㅂ","ㅈ","ㄷ","ㄱ","ㅅ","ㅛ","ㅕ","ㅑ","ㅐ","ㅔ"],row2:["ㅁ","ㄴ","ㅇ","ㄹ","ㅎ","ㅗ","ㅓ","ㅏ","ㅣ"],row3:["ㅋ","ㅌ","ㅊ","ㅍ","ㅠ","ㅜ","ㅡ"],numbers:["1","2","3","4","5","6","7","8","9","0"]},s={row1:["ㅃ","ㅉ","ㄸ","ㄲ","ㅆ","ㅛ","ㅕ","ㅑ","ㅒ","ㅖ"],row2:["ㅁ","ㄴ","ㅇ","ㄹ","ㅎ","ㅗ","ㅓ","ㅏ","ㅣ"],row3:["ㅋ","ㅌ","ㅊ","ㅍ","ㅠ","ㅜ","ㅡ"],numbers:["!","@","#","$","%","^","&","*","(",")"]},r={row1:["q","w","e","r","t","y","u","i","o","p"],row2:["a","s","d","f","g","h","j","k","l"],row3:["z","x","c","v","b","n","m"],numbers:["1","2","3","4","5","6","7","8","9","0"]},h={row1:["Q","W","E","R","T","Y","U","I","O","P"],row2:["A","S","D","F","G","H","J","K","L"],row3:["Z","X","C","V","B","N","M"],numbers:["!","@","#","$","%","^","&","*","(",")"]},l=e?c?s:E:c?h:r,y=a-32,b=d-140,C=Math.max(l.numbers.length,l.row1.length,l.row2.length,l.row3.length+2),S=Math.min(Math.max(24,Math.floor(y/C)-4),60),P=Math.min(Math.max(24,Math.floor(b/5)-4),50),v={width:`${S}px`,height:`${P}px`,fontSize:`${Math.max(10,S*.4)}px`},N={...v,width:`${S*1.5}px`},m={...v,width:`${S*4}px`};return n.jsxs("div",{className:"flex-1 p-4",style:{minHeight:`${b}px`},children:[n.jsx("div",{className:"flex gap-1 mb-1 justify-center",children:l.numbers.map((j,L)=>n.jsx("button",{onClick:()=>u(j),style:v,className:"bg-gray-600 hover:bg-gray-500 text-white rounded font-medium transition-colors",children:j},`num-${L}`))}),n.jsx("div",{className:"flex gap-1 mb-1 justify-center",children:l.row1.map((j,L)=>n.jsx("button",{onClick:()=>u(j),style:v,className:"bg-gray-600 hover:bg-gray-500 text-white rounded font-medium transition-colors",children:j},`row1-${L}`))}),n.jsx("div",{className:"flex gap-1 mb-1 justify-center",children:l.row2.map((j,L)=>n.jsx("button",{onClick:()=>u(j),style:v,className:"bg-gray-600 hover:bg-gray-500 text-white rounded font-medium transition-colors",children:j},`row2-${L}`))}),n.jsxs("div",{className:"flex gap-1 mb-1 justify-center",children:[n.jsx("button",{onClick:p,style:N,className:`rounded font-medium transition-colors ${c?"bg-blue-600 hover:bg-blue-500 text-white":"bg-gray-600 hover:bg-gray-500 text-white"}`,children:"⇧"}),l.row3.map((j,L)=>n.jsx("button",{onClick:()=>u(j),style:v,className:"bg-gray-600 hover:bg-gray-500 text-white rounded font-medium transition-colors",children:j},`row3-${L}`)),n.jsx("button",{onClick:()=>u("Backspace"),style:N,className:"bg-red-600 hover:bg-red-500 text-white rounded font-medium transition-colors",children:"⌫"})]}),n.jsxs("div",{className:"flex gap-1 justify-center",children:[n.jsx("button",{onClick:w,style:v,className:"bg-blue-600 hover:bg-blue-500 text-white rounded font-medium transition-colors",children:e?"한":"EN"}),n.jsx("button",{onClick:()=>u(" "),style:m,className:"bg-gray-600 hover:bg-gray-500 text-white rounded font-medium transition-colors",children:"Space"}),n.jsx("button",{onClick:()=>u("Enter"),style:N,className:"bg-green-600 hover:bg-green-500 text-white rounded font-medium transition-colors",children:"↵"})]})]})},le=({currentText:e,onTextChange:c,onApply:u,onCancel:p,onClearAll:w})=>n.jsx("div",{className:"p-3 bg-gray-700 border-b border-gray-600",children:n.jsxs("div",{className:"flex gap-2",children:[n.jsx("textarea",{value:e,onChange:a=>c(a.target.value),className:"flex-1 h-12 px-3 py-2 bg-gray-800 border border-gray-600 rounded text-white text-sm resize-none focus:outline-none focus:border-blue-500",placeholder:"텍스트 입력..."}),n.jsxs("div",{className:"flex flex-col gap-1",children:[n.jsxs("div",{className:"flex gap-1",children:[n.jsx("button",{onClick:u,className:"px-3 py-1 bg-blue-600 hover:bg-blue-500 text-white rounded text-xs font-medium transition-colors",children:"적용"}),n.jsx("button",{onClick:p,className:"px-3 py-1 bg-gray-600 hover:bg-gray-500 text-white rounded text-xs font-medium transition-colors",children:"취소"})]}),n.jsx("button",{onClick:w,className:"px-3 py-1 bg-red-600 hover:bg-red-500 text-white rounded text-xs font-medium transition-colors",children:"전체삭제"})]})]})}),ce=({onPointerDown:e})=>n.jsx("div",{className:"bg-gray-700 px-3 py-2 rounded-t-lg border-b border-gray-600 cursor-move select-none flex items-center",onPointerDown:e,children:n.jsx("div",{className:"text-gray-300 font-medium text-sm",children:"🎹 가상 키보드"})}),de=({onPointerDown:e})=>n.jsxs("div",{className:"absolute bottom-0 right-0 w-4 h-4 bg-gray-600 hover:bg-gray-500 cursor-se-resize transition-colors",style:{clipPath:"polygon(100% 0, 100% 100%, 0 100%)"},onPointerDown:e,title:"드래그하여 크기 조절",children:[n.jsx("div",{className:"absolute bottom-1 right-1 w-1 h-1 bg-gray-400 rounded-full"}),n.jsx("div",{className:"absolute bottom-1 right-2 w-1 h-1 bg-gray-400 rounded-full"}),n.jsx("div",{className:"absolute bottom-2 right-1 w-1 h-1 bg-gray-400 rounded-full"})]}),ue=["ㄱ","ㄲ","ㄴ","ㄷ","ㄸ","ㄹ","ㅁ","ㅂ","ㅃ","ㅅ","ㅆ","ㅇ","ㅈ","ㅉ","ㅊ","ㅋ","ㅌ","ㅍ","ㅎ"],he=["ㅏ","ㅐ","ㅑ","ㅒ","ㅓ","ㅔ","ㅕ","ㅖ","ㅗ","ㅘ","ㅙ","ㅚ","ㅛ","ㅜ","ㅝ","ㅞ","ㅟ","ㅠ","ㅡ","ㅢ","ㅣ"],fe=["","ㄱ","ㄲ","ㄳ","ㄴ","ㄵ","ㄶ","ㄷ","ㄹ","ㄺ","ㄻ","ㄼ","ㄽ","ㄾ","ㄿ","ㅀ","ㅁ","ㅂ","ㅄ","ㅅ","ㅆ","ㅇ","ㅈ","ㅊ","ㅋ","ㅌ","ㅍ","ㅎ"],ge="ㄱㄲㄴㄷㄸㄹㅁㅂㅃㅅㅆㅇㅈㅉㅊㅋㅌㅍㅎ",me="ㅏㅑㅓㅕㅗㅛㅜㅠㅡㅣㅐㅔㅒㅖㅘㅙㅚㅝㅞㅟㅢ",be={ㅗㅏ:"ㅘ",ㅗㅐ:"ㅙ",ㅗㅣ:"ㅚ",ㅜㅓ:"ㅝ",ㅜㅔ:"ㅞ",ㅜㅣ:"ㅟ",ㅡㅣ:"ㅢ"},xe={ㄱㅅ:"ㄳ",ㄴㅈ:"ㄵ",ㄴㅎ:"ㄶ",ㄹㄱ:"ㄺ",ㄹㅁ:"ㄻ",ㄹㅂ:"ㄼ",ㄹㅅ:"ㄽ",ㄹㅌ:"ㄾ",ㄹㅍ:"ㄿ",ㄹㅎ:"ㅀ",ㅂㅅ:"ㅄ"},V=(e,c,u="")=>{const p=ue.indexOf(e),w=he.indexOf(c),a=fe.indexOf(u);if(p>=0&&w>=0&&a>=0){const d=44032+(p*21+w)*28+a;return String.fromCharCode(d)}return""},pe=e=>ge.includes(e),we=e=>me.includes(e),ye=(e,c)=>be[e+c]||null,ve=(e,c)=>xe[e+c]||null,Ce=()=>{const[e,c]=o.useState({initial:"",middle:"",final:"",isAssembling:!1}),u=o.useCallback((s,r)=>pe(s)?p(s,r):we(s)?w(s,r):(d(),r+s),[e]),p=o.useCallback((s,r)=>{if(!e.isAssembling)return c({initial:s,middle:"",final:"",isAssembling:!0}),r+s;if(e.initial&&e.middle&&!e.final){c(l=>({...l,final:s}));const f=V(e.initial,e.middle,s);return f?r.slice(0,-1)+f:r+s}if(e.initial&&e.middle&&e.final){const f=ve(e.final,s);if(f){c(y=>({...y,final:f}));const l=V(e.initial,e.middle,f);if(l)return r.slice(0,-1)+l}else{const l=V(e.initial,e.middle,e.final);return c({initial:s,middle:"",final:"",isAssembling:!0}),r.slice(0,-1)+l+s}}let h=r;if(e.initial&&e.middle){const f=V(e.initial,e.middle);f&&(h=r.slice(0,-1)+f)}return c({initial:s,middle:"",final:"",isAssembling:!0}),h+s},[e]),w=o.useCallback((s,r)=>{if(e.isAssembling&&e.initial&&!e.middle){c(f=>({...f,middle:s}));const h=V(e.initial,s);return h?r.slice(0,-1)+h:r+s}if(e.initial&&e.middle&&!e.final){const h=ye(e.middle,s);if(h){c(l=>({...l,middle:h}));const f=V(e.initial,h);if(f)return r.slice(0,-1)+f}else{const f=V(e.initial,e.middle);return d(),r.slice(0,-1)+f+s}}if(e.initial&&e.middle&&e.final){const h=e.final,f=V(e.initial,e.middle);c({initial:h,middle:s,final:"",isAssembling:!0});const l=V(h,s);if(f&&l)return r.slice(0,-1)+f+l}return d(),r+s},[e]),a=o.useCallback(s=>{if(!e.isAssembling||s.length===0)return d(),s.slice(0,-1);if(e.final){c(h=>({...h,final:""}));const r=V(e.initial,e.middle);if(r)return s.slice(0,-1)+r}else{if(e.middle)return c(r=>({...r,middle:""})),s.slice(0,-1)+e.initial;if(e.initial)return d(),s.slice(0,-1)}return s.slice(0,-1)},[e]),d=o.useCallback(()=>{c({initial:"",middle:"",final:"",isAssembling:!1})},[]),E=o.useCallback(s=>{if(e.isAssembling&&e.initial&&e.middle){const r=V(e.initial,e.middle,e.final);if(r)return d(),s.slice(0,-1)+r}return d(),s},[e]);return{hangulState:e,processKoreanInput:u,processBackspace:a,resetHangulState:d,finalizeCurrentChar:E}},Se=()=>{const c=o.useCallback(()=>{try{const O=localStorage.getItem("viewVirtualKeyboard_position"),g=localStorage.getItem("viewVirtualKeyboard_size"),z={x:50,y:window.innerHeight-300},W={width:600,height:280};return{position:O?JSON.parse(O):z,size:g?JSON.parse(g):W}}catch{return{position:{x:50,y:window.innerHeight-300},size:{width:600,height:280}}}},[])(),[u,p]=o.useState(!1),[w,a]=o.useState(c.position),[d,E]=o.useState(c.size),[s,r]=o.useState(!1),[h,f]=o.useState(!1),[l,y]=o.useState({x:0,y:0}),[b,C]=o.useState(!0),[S,P]=o.useState(!1),[v,N]=o.useState(!1),[m,j]=o.useState(""),L=o.useCallback((O,g)=>{try{localStorage.setItem("viewVirtualKeyboard_position",JSON.stringify(O)),localStorage.setItem("viewVirtualKeyboard_size",JSON.stringify(g))}catch(z){console.warn("Failed to save keyboard settings:",z)}},[]),$=o.useCallback((O,g)=>{const W=g.width*.2,X=g.height*.2,K=window.innerWidth-W,_=window.innerHeight-X,J=-g.width+W,B=-g.height+X;return{x:Math.max(J,Math.min(K,O.x)),y:Math.max(B,Math.min(_,O.y))}},[]),D=o.useCallback(()=>{S&&!v?N(!0):v?(P(!1),N(!1)):P(!0)},[S,v]),T=o.useCallback(()=>{S&&!v&&P(!1)},[S,v]);return{isVisible:u,position:w,size:d,isDragging:s,isResizing:h,dragOffset:l,isKorean:b,isShiftPressed:S,shiftLocked:v,currentText:m,setIsVisible:p,setPosition:a,setSize:E,setIsDragging:r,setIsResizing:f,setDragOffset:y,setIsKorean:C,setCurrentText:j,saveSettings:L,constrainToViewport:$,handleShiftPress:D,updateShiftAfterKeyPress:T}},je=({isDragging:e,isResizing:c,dragOffset:u,position:p,size:w,keyboardRef:a,setPosition:d,setSize:E,setIsDragging:s,setIsResizing:r,saveSettings:h,constrainToViewport:f})=>{o.useEffect(()=>{if(!e&&!c)return;const b=S=>{var P;if(e){const v={x:S.clientX-u.x,y:S.clientY-u.y},N=f(v,w);d(N)}if(c){const v=(P=a.current)==null?void 0:P.getBoundingClientRect();if(v){const N=Math.max(400,Math.min(800,S.clientX-v.left)),m=Math.max(250,Math.min(400,S.clientY-v.top)),j={width:N,height:m},L=f(p,j);E(j),d(L)}}},C=S=>{if((e||c)&&h(p,w),s(!1),r(!1),a.current)try{a.current.releasePointerCapture(S.pointerId)}catch{}};return document.addEventListener("pointermove",b),document.addEventListener("pointerup",C),()=>{document.removeEventListener("pointermove",b),document.removeEventListener("pointerup",C)}},[e,c,u,p,w,a,d,E,s,r,h,f]),o.useEffect(()=>{const b=()=>{const C=f(p,w);(C.x!==p.x||C.y!==p.y)&&(d(C),h(C,w))};return window.addEventListener("resize",b),()=>window.removeEventListener("resize",b)},[p,w,f,d,h]);const l=o.useCallback(b=>{b.preventDefault(),b.stopPropagation(),s(!0);try{b.currentTarget.setPointerCapture(b.pointerId)}catch{}},[s,a]),y=o.useCallback(b=>{b.preventDefault(),b.stopPropagation(),r(!0);try{b.currentTarget.setPointerCapture(b.pointerId)}catch{}},[r]);return{handleDragStart:l,handleResizeStart:y}},ke=()=>{const{textObjects:e,updateTextObject:c}=te(),{selectedObjectId:u}=ie(),p=o.useRef(null),{isVisible:w,position:a,size:d,isDragging:E,isResizing:s,dragOffset:r,isKorean:h,isShiftPressed:f,currentText:l,setIsVisible:y,setPosition:b,setSize:C,setIsDragging:S,setIsResizing:P,setDragOffset:v,setIsKorean:N,setCurrentText:m,saveSettings:j,constrainToViewport:L,handleShiftPress:$,updateShiftAfterKeyPress:D}=Se(),{processKoreanInput:T,processBackspace:O,resetHangulState:g,finalizeCurrentChar:z}=Ce();je({isDragging:E,isResizing:s,dragOffset:r,position:a,size:d,keyboardRef:p,setPosition:b,setSize:C,setIsDragging:S,setIsResizing:P,saveSettings:j,constrainToViewport:L}),o.useEffect(()=>{const i=L(a,d);(i.x!==a.x||i.y!==a.y)&&(b(i),j(i,d))},[]),o.useEffect(()=>{const i=F=>{const{objectId:U}=F.detail,q=e.find(Z=>Z.id===U);q&&(m(q.text),g(),y(!0))},k=()=>{y(!1),m(""),g()};return window.addEventListener("activateVirtualKeyboard",i),window.addEventListener("hideVirtualKeyboard",k),()=>{window.removeEventListener("activateVirtualKeyboard",i),window.removeEventListener("hideVirtualKeyboard",k)}},[u,e,y,m,g]),o.useEffect(()=>{w&&(u||(y(!1),m(""),g()))},[u,w,y,m,g]);const W=o.useCallback(i=>{var F;i.preventDefault(),i.stopPropagation(),S(!0);try{i.currentTarget.setPointerCapture(i.pointerId)}catch{}const k=(F=p.current)==null?void 0:F.getBoundingClientRect();k&&v({x:i.clientX-k.left,y:i.clientY-k.top})},[S,v]),X=o.useCallback(i=>{i.preventDefault(),i.stopPropagation(),P(!0);try{i.currentTarget.setPointerCapture(i.pointerId)}catch{}},[P]),K=o.useCallback(i=>{if(i==="Backspace")if(h){const k=O(l);m(k)}else m(k=>k.slice(0,-1)),g();else if(i==="Enter")B();else if(i===" "){const k=z(l);m(k+" ")}else{if(h){const k=T(i,l);m(k)}else{const k=z(l);m(k+i)}D()}},[h,l,O,T,z,g,D]),_=o.useCallback(()=>{const i=z(l);m(i),N(!h)},[h,N,l,z,m]),J=o.useCallback(i=>{m(i),g()},[m,g]),B=o.useCallback(()=>{if(u){const i=z(l);c(u,{text:i,isEditing:!1})}y(!1),m(""),g()},[u,l,z,c,y,m,g]),ne=o.useCallback(()=>{y(!1),m(""),g()},[y,m,g]),M=o.useCallback(()=>{m(""),g()},[m,g]);return w?n.jsxs("div",{ref:p,"data-virtual-keyboard":"true",className:"fixed bg-gray-800 bg-opacity-95 rounded-lg shadow-2xl border border-gray-600 select-none",style:{left:a.x,top:a.y,width:d.width,height:d.height,zIndex:9999},onClick:i=>i.stopPropagation(),onPointerDown:i=>i.stopPropagation(),children:[n.jsx(ce,{onPointerDown:W}),n.jsx(le,{currentText:l,onTextChange:J,onApply:B,onCancel:ne,onClearAll:M}),n.jsx(ae,{isKorean:h,isShiftPressed:f,onKeyPress:K,onShiftPress:$,onLanguageToggle:_,keyboardWidth:d.width,keyboardHeight:d.height}),n.jsx(de,{onPointerDown:X})]}):null},ze=()=>{var d;const{initializeFirebaseListeners:e,settings:c}=te(),u=((d=c==null?void 0:c.view)==null?void 0:d.virtualKeyboardEnabled)??!0,[p,w]=o.useState(!0),a=o.useRef(null);return o.useEffect(()=>(e(),()=>{const{cleanupFirebaseListeners:E}=te.getState();E()}),[e]),o.useEffect(()=>{const E=()=>{a.current&&clearTimeout(a.current),a.current=setTimeout(()=>{w(!1)},1e4)},s=()=>{w(!0),E()},r=()=>{s()};return E(),window.addEventListener("mousemove",r),window.addEventListener("mousedown",r),window.addEventListener("click",r),window.addEventListener("touchstart",r),()=>{a.current&&clearTimeout(a.current),window.removeEventListener("mousemove",r),window.removeEventListener("mousedown",r),window.removeEventListener("click",r),window.removeEventListener("touchstart",r)}},[]),n.jsxs("div",{className:"w-screen h-screen overflow-hidden relative",children:[n.jsx("main",{className:"w-full h-full",children:n.jsx(se,{isViewPage:!0})}),p&&n.jsx(re,{}),u&&n.jsx(ke,{})]})};export{ze as default};
