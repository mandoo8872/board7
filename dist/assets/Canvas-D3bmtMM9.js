import{r as f,j as k,R as ke}from"./index-DzA4qqIn.js";import{c as pe,i as Ge,b as qe,u as Se,r as Ze,d as _e,e as Je,l as Qe}from"./PasswordGate-Det3IteZ.js";const De=pe((e,t)=>({currentTool:"select",zoom:1,viewOffset:{x:0,y:0},selectedObjectId:null,creationMode:null,hoveredObjectId:null,setCurrentTool:n=>e({currentTool:n}),setZoom:n=>e({zoom:Math.max(.05,Math.min(5,n))}),setViewOffset:n=>e({viewOffset:n}),setSelectedObjectId:n=>e({selectedObjectId:n}),setCreationMode:n=>e({creationMode:n}),setHoveredObjectId:n=>e({hoveredObjectId:n}),zoomIn:()=>e(n=>({zoom:Math.min(5,n.zoom+.1)})),zoomOut:()=>e(n=>({zoom:Math.max(.05,n.zoom-.1)})),zoomAtPoint:(n,o,r,a)=>{const i=t(),s=1.1,l=n>0?Math.min(5,i.zoom*s):Math.max(.05,i.zoom/s);if(l===i.zoom)return;const u=a.height/2,y=r-u,b=l/i.zoom,C=i.viewOffset.x,h=i.viewOffset.y+y*(1-b);e({zoom:l,viewOffset:{x:C,y:h}})},resetZoom:()=>e({zoom:1,viewOffset:{x:0,y:0}}),fitToWindow:()=>e({zoom:1,viewOffset:{x:0,y:0}})}));pe(e=>({isDragging:!1,viewCam:{x:0,y:0},snapEnabled:!0,setIsDragging:t=>e({isDragging:t}),setViewCam:t=>e({viewCam:t}),setSnapEnabled:t=>e({snapEnabled:t}),panCanvas:(t,n)=>e(o=>({viewCam:{x:o.viewCam.x+t,y:o.viewCam.y+n}})),resetView:()=>e({viewCam:{x:0,y:0}})}));const Ve=pe(e=>({currentStroke:[],currentPressureStroke:[],isDrawing:!1,penColor:"#000000",penWidth:4,usePerfectFreehand:!0,lastActionTime:0,defaultColors:["#000000","#FF0000","#00FF00","#0000FF","#FFFF00","#FF00FF","#00FFFF","#FFA500","#800080","#A52A2A"],addPoint:(t,n,o=.5,r=0,a=0)=>e(i=>({currentStroke:[...i.currentStroke,t,n],currentPressureStroke:[...i.currentPressureStroke,{x:t,y:n,pressure:o,tiltX:r,tiltY:a}]})),startStroke:()=>e({isDrawing:!0,currentStroke:[]}),endStroke:()=>e({isDrawing:!1}),clearCurrentStroke:()=>e({currentStroke:[],currentPressureStroke:[]}),setPenColor:t=>e({penColor:t}),setPenWidth:t=>e({penWidth:t}),setUsePerfectFreehand:t=>e({usePerfectFreehand:t}),updateLastActionTime:()=>e({lastActionTime:Date.now()})}));pe(e=>({gridEnabled:!1,gridSize:10,snapEnabled:!0,setGridEnabled:t=>e({gridEnabled:t}),setGridSize:t=>e({gridSize:t}),setSnapEnabled:t=>e({snapEnabled:t})}));const et=pe(e=>({defaultCheckedColor:"#10b981",defaultUncheckedColor:"#f3f4f6",checkedBackgroundColor:"#dcfce7",uncheckedBackgroundColor:"#ffffff",checkedBackgroundOpacity:.8,uncheckedBackgroundOpacity:1,setDefaultCheckedColor:t=>e({defaultCheckedColor:t}),setDefaultUncheckedColor:t=>e({defaultUncheckedColor:t}),setCheckedBackgroundColor:t=>e({checkedBackgroundColor:t}),setUncheckedBackgroundColor:t=>e({uncheckedBackgroundColor:t}),setCheckedBackgroundOpacity:t=>e({checkedBackgroundOpacity:t}),setUncheckedBackgroundOpacity:t=>e({uncheckedBackgroundOpacity:t})})),fe=pe((e,t)=>({selectedCellIds:new Set,isDragSelecting:!1,dragStartPoint:null,dragEndPoint:null,selectCell:(n,o=!1)=>{e(r=>{const a=new Set(r.selectedCellIds);return o?a.has(n)?a.delete(n):a.add(n):(a.clear(),a.add(n)),{selectedCellIds:a}})},selectCellsInRange:n=>{e(o=>{const r=new Set(o.selectedCellIds);return n.forEach(a=>r.add(a)),{selectedCellIds:r}})},deselectCell:n=>{e(o=>{const r=new Set(o.selectedCellIds);return r.delete(n),{selectedCellIds:r}})},clearSelection:()=>{e({selectedCellIds:new Set})},toggleCellSelection:n=>{e(o=>{const r=new Set(o.selectedCellIds);return r.has(n)?r.delete(n):r.add(n),{selectedCellIds:r}})},startDragSelection:(n,o)=>{e({isDragSelecting:!0,dragStartPoint:{x:n,y:o},dragEndPoint:{x:n,y:o}})},updateDragSelection:(n,o)=>{e(()=>({dragEndPoint:{x:n,y:o}}))},endDragSelection:()=>{e({isDragSelecting:!1,dragStartPoint:null,dragEndPoint:null})},isSelected:n=>t().selectedCellIds.has(n),getSelectedCount:()=>t().selectedCellIds.size,getSelectedCells:()=>Array.from(t().selectedCellIds)})),tt=({text:e,textStyle:t,fontSize:n,onChange:o,onBlur:r,onKeyDown:a})=>{const i=f.useRef(null);return f.useEffect(()=>{if(i.current){const s=i.current,l=e.length;s.focus(),setTimeout(()=>{s.setSelectionRange(l,l)},0)}},[]),k.jsx("textarea",{ref:i,value:e,onChange:s=>o(s.target.value),onBlur:r,onKeyDown:a,"data-editing":"true",className:"w-full h-full bg-transparent border-none outline-none resize-none",style:{color:t.color,fontFamily:t.fontFamily,fontSize:`${n}px`,fontWeight:t.bold?"bold":"normal",fontStyle:t.italic?"italic":"normal",textAlign:t.horizontalAlign,lineHeight:"1.2",wordBreak:"break-word",cursor:"text"}})},Ye=({onPointerDown:e,objectId:t})=>k.jsxs(k.Fragment,{children:[k.jsx("div",{className:"absolute w-3 h-3 bg-blue-600 border-2 border-white rounded-sm cursor-nw-resize shadow-md",style:{left:-6,top:-6},onPointerDown:n=>e(n,"nw",t)}),k.jsx("div",{className:"absolute w-3 h-3 bg-blue-600 border-2 border-white rounded-sm cursor-ne-resize shadow-md",style:{right:-6,top:-6},onPointerDown:n=>e(n,"ne",t)}),k.jsx("div",{className:"absolute w-3 h-3 bg-blue-600 border-2 border-white rounded-sm cursor-sw-resize shadow-md",style:{left:-6,bottom:-6},onPointerDown:n=>e(n,"sw",t)}),k.jsx("div",{className:"absolute w-3 h-3 bg-blue-600 border-2 border-white rounded-sm cursor-se-resize shadow-md",style:{right:-6,bottom:-6},onPointerDown:n=>e(n,"se",t)}),k.jsx("div",{className:"absolute w-3 h-3 bg-blue-600 border-2 border-white rounded-sm cursor-n-resize shadow-md",style:{left:"50%",top:-6,transform:"translateX(-50%)"},onPointerDown:n=>e(n,"n",t)}),k.jsx("div",{className:"absolute w-3 h-3 bg-blue-600 border-2 border-white rounded-sm cursor-s-resize shadow-md",style:{left:"50%",bottom:-6,transform:"translateX(-50%)"},onPointerDown:n=>e(n,"s",t)}),k.jsx("div",{className:"absolute w-3 h-3 bg-blue-600 border-2 border-white rounded-sm cursor-w-resize shadow-md",style:{left:-6,top:"50%",transform:"translateY(-50%)"},onPointerDown:n=>e(n,"w",t)}),k.jsx("div",{className:"absolute w-3 h-3 bg-blue-600 border-2 border-white rounded-sm cursor-e-resize shadow-md",style:{right:-6,top:"50%",transform:"translateY(-50%)"},onPointerDown:n=>e(n,"e",t)})]}),nt=({obj:e,isSelected:t,isHovered:n,isViewPage:o,isDragging:r,currentX:a,currentY:i,currentWidth:s,currentHeight:l,currentTool:u,editingObjectId:y,editingText:b,onTextBoxClick:C,onObjectClick:h,onPointerDown:p,onResizePointerDown:M,onMouseEnter:W,onMouseLeave:G,onEditingTextChange:D,onFinishEdit:N,onKeyDown:K,updateTextObject:j})=>{var w,L;const{defaultCheckedColor:U,defaultUncheckedColor:g,checkedBackgroundColor:V,uncheckedBackgroundColor:ee,checkedBackgroundOpacity:_,uncheckedBackgroundOpacity:J}=et(),X=e.cellType==="cell"&&fe.getState().isSelected(e.id),H=e.boxStyle||{backgroundColor:"transparent",backgroundOpacity:1,borderColor:"#000000",borderWidth:0,borderRadius:0},P=e.textStyle||{color:"#000000",bold:!1,italic:!1,horizontalAlign:"left",verticalAlign:"middle",fontFamily:"Arial"},E=S=>{S.stopPropagation();const O=!e.checkboxChecked;j(e.id,{checkboxChecked:O,checkboxCheckedColor:e.checkboxCheckedColor||U,checkboxUncheckedColor:e.checkboxUncheckedColor||g})},z=S=>{S.stopPropagation()};return k.jsxs("div",{className:`absolute select-none ${t?"ring-4 ring-blue-600":n?"ring-2 ring-gray-400":""}`,style:{left:a,top:i,width:s,height:l,opacity:e.opacity,zIndex:e.zIndex||0,cursor:y===e.id?"text":o?"default":r?"grabbing":(w=e.permissions)!=null&&w.movable?"grab":"default",border:`${H.borderWidth}px solid ${H.borderColor}`,borderRadius:`${H.borderRadius}px`,transition:r?"none":"all 0.1s ease",pointerEvents:u==="pen"||u==="eraser"?"none":"auto"},onClick:S=>{r?h(S,e.id):C(e,S)},onPointerDown:S=>p(S,e.id),onMouseEnter:W,onMouseLeave:G,children:[k.jsx("div",{className:"absolute inset-0",style:{backgroundColor:X?"#9ca3af":e.hasCheckbox&&e.checkboxChecked?e.checkedBackgroundColor||V:e.hasCheckbox&&!e.checkboxChecked?e.uncheckedBackgroundColor||ee:H.backgroundColor,opacity:X?.15:e.hasCheckbox&&e.checkboxChecked?e.checkedBackgroundOpacity??_:e.hasCheckbox&&!e.checkboxChecked?e.uncheckedBackgroundOpacity??J:H.backgroundOpacity,borderRadius:`${H.borderRadius}px`}}),k.jsx("div",{className:"relative z-10 h-full flex items-center",style:{justifyContent:P.horizontalAlign==="left"?"flex-start":P.horizontalAlign==="center"?"center":"flex-end",alignItems:P.verticalAlign==="top"?"flex-start":P.verticalAlign==="middle"?"center":"flex-end",padding:"8px"},children:y===e.id?k.jsx(tt,{text:b,textStyle:P,fontSize:e.fontSize||16,onChange:D,onBlur:N,onKeyDown:K}):k.jsxs("div",{style:{color:P.color,fontFamily:P.fontFamily,fontSize:`${e.fontSize||16}px`,fontWeight:P.bold?"bold":"normal",fontStyle:P.italic?"italic":"normal",textAlign:P.horizontalAlign,lineHeight:"1.2",wordBreak:"break-word",cursor:"pointer",display:"flex",alignItems:P.verticalAlign==="top"?"flex-start":P.verticalAlign==="middle"?"center":"flex-end",width:"100%",height:"100%"},children:[e.hasCheckbox&&k.jsx("div",{className:"checkbox-area",onClick:E,onPointerDown:z,style:{display:"inline-flex",alignItems:"center",justifyContent:"center",width:"35px",height:"35px",backgroundColor:e.checkboxChecked?e.checkboxCheckedColor||U:e.checkboxUncheckedColor||g,border:`2px solid ${e.checkboxChecked?e.checkboxCheckedColor||U:"#d1d5db"}`,borderRadius:"4px",marginRight:"8px",transition:"all 0.2s ease",userSelect:"none",flexShrink:0,pointerEvents:"auto",cursor:"pointer"},children:e.checkboxChecked&&k.jsx("svg",{className:"checkbox-area",width:"16",height:"16",viewBox:"0 0 16 16",fill:"none",xmlns:"http://www.w3.org/2000/svg",children:k.jsx("path",{className:"checkbox-area",d:"M13.5 4.5L6 12L2.5 8.5",stroke:"white",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round"})})}),k.jsx("span",{style:{flex:1},children:e.text})]})}),t&&!o&&((L=e.permissions)==null?void 0:L.resizable)&&k.jsx(Ye,{onPointerDown:M,objectId:e.id})]})},rt=({obj:e,isSelected:t,isHovered:n,isViewPage:o,isDragging:r,currentX:a,currentY:i,currentWidth:s,currentHeight:l,currentTool:u,editingObjectId:y,onObjectClick:b,onPointerDown:C,onResizePointerDown:h,onMouseEnter:p,onMouseLeave:M})=>{var W,G;return k.jsxs("div",{className:`absolute select-none ${t?"ring-4 ring-blue-600":n?"ring-2 ring-gray-400":""}`,style:{left:a,top:i,width:s,height:l,opacity:e.opacity,zIndex:e.zIndex||0,cursor:y===e.id?"text":o?"default":r?"grabbing":(W=e.permissions)!=null&&W.movable?"grab":"default",transition:r?"none":"all 0.1s ease",pointerEvents:u==="pen"||u==="eraser"?"none":"auto"},onClick:D=>b(D,e.id),onPointerDown:D=>C(D,e.id),onMouseEnter:p,onMouseLeave:M,children:[k.jsx("img",{src:e.src,alt:"",className:`w-full h-full ${e.maintainAspectRatio?"object-contain":"object-fill"}`,draggable:!1,style:{pointerEvents:"none"}}),t&&!o&&((G=e.permissions)==null?void 0:G.resizable)&&k.jsx(Ye,{onPointerDown:h,objectId:e.id})]})},Re={isDragging:!1,draggedObjectId:null,offset:{x:0,y:0},currentPosition:{x:0,y:0}},ot=()=>{const[e,t]=f.useState(Re),n=f.useCallback((i,s,l)=>{t({isDragging:!0,draggedObjectId:i,offset:s,currentPosition:l})},[]),o=f.useCallback(i=>{t(s=>({...s,currentPosition:i}))},[]),r=f.useCallback(()=>{t(Re)},[]),a=f.useCallback(i=>e.isDragging&&e.draggedObjectId===i,[e.isDragging,e.draggedObjectId]);return{dragState:e,startDrag:n,updateDragPosition:o,endDrag:r,isDraggingObject:a}},Ie={isResizing:!1,resizedObjectId:null,resizeHandle:null,startPosition:{x:0,y:0},startSize:{width:0,height:0},startObjectPosition:{x:0,y:0}},it=()=>{const[e,t]=f.useState(Ie),n=f.useCallback((i,s,l,u,y)=>{t({isResizing:!0,resizedObjectId:i,resizeHandle:s,startPosition:l,startSize:u,startObjectPosition:y})},[]),o=f.useCallback((i,s)=>{t(l=>({...l,currentSize:i,currentPosition:s}))},[]),r=f.useCallback(()=>{t(Ie)},[]),a=f.useCallback(i=>e.isResizing&&e.resizedObjectId===i,[e.isResizing,e.resizedObjectId]);return{resizeState:e,startResize:n,updateResize:o,endResize:r,isResizingObject:a}},st=(e,t,n=!1)=>{const[o,r]=f.useState(null),[a,i]=f.useState(""),s=f.useCallback(b=>{r(b.id),i(b.text),e(b.id,{isEditing:!0}),n?(t(b.id),setTimeout(()=>{window.dispatchEvent(new CustomEvent("activateVirtualKeyboard",{detail:{objectId:b.id}}))},100)):setTimeout(()=>{const C=document.querySelector('textarea[data-editing="true"]');if(C){const h=b.text.length;C.setSelectionRange(h,h),C.focus()}},0)},[n,e,t]),l=f.useCallback(async()=>{o&&a!==void 0&&(await e(o,{text:a,isEditing:!1}),r(null),i(""))},[o,a,e]),u=f.useCallback(()=>{r(null),i("")},[]),y=f.useCallback(b=>{i(b)},[]);return{editingObjectId:o,editingText:a,startInlineEdit:s,finishInlineEdit:l,cancelInlineEdit:u,updateEditingText:y}},at=()=>{const e=f.useRef(!1),t=f.useRef(0);f.useEffect(()=>{const a=navigator.userAgent.toLowerCase(),i=/iphone|ipad|ipod/.test(a),s=/safari/.test(a)&&!/chrome/.test(a);e.current=i||s},[]);const n=a=>{t.current=a},o=a=>e.current&&a-t.current<300,r=()=>{const a=navigator.userAgent.toLowerCase();return/iphone/.test(a)};return{isSafari:e.current,updatePointerEventTime:n,isGhostClick:o,isIPhone:r}},ct=(e,t)=>{var o;return{handleClipboardPaste:f.useCallback(async()=>{try{if(!navigator.clipboard||!navigator.clipboard.read){console.warn("ÌÅ¥Î¶ΩÎ≥¥Îìú APIÍ∞Ä ÏßÄÏõêÎêòÏßÄ ÏïäÏäµÎãàÎã§.");return}const r=await navigator.clipboard.read();for(const a of r){const i=a.types.filter(s=>s.startsWith("image/"));if(i.length>0){const s=i[0],l=await a.getType(s),u=new FileReader;u.onload=async y=>{var p,M;const b=(p=y.target)==null?void 0:p.result,C=((M=t==null?void 0:t.admin)==null?void 0:M.objectCreationPosition)??{x:260,y:950},h=new Image;h.onload=async()=>{try{const D=200*(h.naturalHeight/h.naturalWidth),N={x:C.x,y:C.y,width:200,height:D,src:b,permissions:{editable:!0,movable:!0,resizable:!0,deletable:!0},zIndex:Date.now(),locked:!1,visible:!0,opacity:1,maintainAspectRatio:!0,lastModified:Date.now()};await e(N),console.log("ÌÅ¥Î¶ΩÎ≥¥Îìú Ïù¥ÎØ∏ÏßÄÍ∞Ä ÏÑ±Í≥µÏ†ÅÏúºÎ°ú Î∂ôÏó¨ÎÑ£Ïñ¥Ï°åÏäµÎãàÎã§.")}catch(W){console.error("Ïù¥ÎØ∏ÏßÄ Í∞ùÏ≤¥ ÏÉùÏÑ± Ïã§Ìå®:",W)}},h.onerror=()=>{console.error("ÌÅ¥Î¶ΩÎ≥¥Îìú Ïù¥ÎØ∏ÏßÄ Î°úÎìú Ïã§Ìå®")},h.src=b},u.onerror=()=>{console.error("ÌÅ¥Î¶ΩÎ≥¥Îìú Ïù¥ÎØ∏ÏßÄ ÏùΩÍ∏∞ Ïã§Ìå®")},u.readAsDataURL(l);break}}}catch(r){console.log("ÌÅ¥Î¶ΩÎ≥¥ÎìúÏóêÏÑú Ïù¥ÎØ∏ÏßÄÎ•º ÏùΩÏùÑ Ïàò ÏóÜÏäµÎãàÎã§:",r)}},[(o=t==null?void 0:t.admin)==null?void 0:o.objectCreationPosition,e])}},lt=(e,t,n,o,r,a,i,s)=>{const l=f.useCallback(async b=>{if(!b)return;const C=e.find(p=>p.id===b);if(C){const p={...C,x:C.x+20,y:C.y+20,isEditing:!1};delete p.id,await r(p);return}const h=t.find(p=>p.id===b);if(h){const p={...h,x:h.x+20,y:h.y+20};delete p.id,await a(p);return}},[e,t,r,a]),u=f.useCallback(async b=>{var p,M;if(!b)return;const C=e.find(W=>W.id===b);if(C&&((p=C.permissions)!=null&&p.deletable)){await n(b),s(null);return}const h=t.find(W=>W.id===b);if(h&&((M=h.permissions)!=null&&M.deletable)){await o(b),s(null);return}},[e,t,n,o,s]),y=f.useCallback(async()=>{const{getSelectedCells:b}=fe.getState(),C=b();if(C.length!==0)try{for(const h of C){const p=e.find(M=>M.id===h);p&&p.cellType==="cell"&&await i(h,{text:""})}console.log(`${C.length}Í∞ú ÏÖÄÏùò ÌÖçÏä§Ìä∏ ÎÇ¥Ïö©Ïù¥ ÏÇ≠Ï†úÎêòÏóàÏäµÎãàÎã§.`)}catch(h){console.error("ÏÖÄ ÌÖçÏä§Ìä∏ ÏùºÍ¥Ñ ÏÇ≠Ï†ú Ïã§Ìå®:",h)}},[e,i]);return{handleDuplicateObject:l,handleDeleteObject:u,handleBulkClearCellText:y}},ve=(e,t)=>Math.round(e/t)*t,dt=(e,t,n)=>({x:ve(e,n),y:ve(t,n)}),ut=(e,t,n,o=50,r=30)=>({width:Math.max(ve(e,n),o),height:Math.max(ve(t,n),r)}),He=e=>{const t=window.getComputedStyle(e).transform;let n=1;if(t&&t!=="none"){const o=t.match(/matrix\(([^)]+)\)/);o&&(n=o[1].split(",").map(a=>parseFloat(a.trim()))[0])}return n},Pe=(e,t,n)=>{const o=n.getBoundingClientRect(),r=He(n);return{x:(e-o.left)/r,y:(t-o.top)/r}},Ee=(e,t,n,o)=>{if(!n)return{position:e,size:t};const r=dt(e.x,e.y,o),a=t?ut(t.width,t.height,o):void 0;return{position:r,size:a}},ht=(e,t,n)=>({x:e.x-t.x/n,y:e.y-t.y/n}),ft=(e,t)=>({x:e.x-t.x,y:e.y-t.y}),Oe=(e,t,n,o)=>{const r=Ge(e)?e:n||{x:0,y:0},a=t&&qe(t)?t:o;return{position:r,size:a}},gt=e=>{const{handle:t,deltaX:n,deltaY:o,startSize:r,startPosition:a,maintainAspectRatio:i=!1,originalAspectRatio:s=1}=e;let l=r.width,u=r.height,y=a.x,b=a.y;switch(t){case"nw":l=Math.max(50,r.width-n),u=i?l/s:Math.max(30,r.height-o),y=a.x+(r.width-l),b=a.y+(r.height-u);break;case"ne":l=Math.max(50,r.width+n),u=i?l/s:Math.max(30,r.height-o),b=a.y+(r.height-u);break;case"sw":l=Math.max(50,r.width-n),u=i?l/s:Math.max(30,r.height+o),y=a.x+(r.width-l);break;case"se":l=Math.max(50,r.width+n),u=i?l/s:Math.max(30,r.height+o);break;case"n":i?(u=Math.max(30,r.height-o),l=u*s,y=a.x+(r.width-l)/2):u=Math.max(30,r.height-o),b=a.y+(r.height-u);break;case"s":i?(u=Math.max(30,r.height+o),l=u*s,y=a.x+(r.width-l)/2):u=Math.max(30,r.height+o);break;case"w":i?(l=Math.max(50,r.width-n),u=l/s,b=a.y+(r.height-u)/2):l=Math.max(50,r.width-n),y=a.x+(r.width-l);break;case"e":i?(l=Math.max(50,r.width+n),u=l/s,b=a.y+(r.height-u)/2):l=Math.max(50,r.width+n);break}return{newWidth:l,newHeight:u,newX:y,newY:b}},pt=e=>{try{e.preventDefault(),e.stopPropagation()}catch(t){console.debug("preventDefault failed in context menu handler:",t)}return!1},mt=(e,t,n)=>{if(e.key==="Enter"&&!e.shiftKey){try{e.preventDefault()}catch(o){console.debug("preventDefault failed in keydown handler:",o)}t()}else if(e.key==="Escape"){try{e.preventDefault()}catch(o){console.debug("preventDefault failed in keydown handler:",o)}n()}},xt=(e,t,n)=>{if(!e.cellPosition||!t.cellPosition||e.groupId!==t.groupId)return[];const o=Math.min(e.cellPosition.row,t.cellPosition.row),r=Math.max(e.cellPosition.row,t.cellPosition.row),a=Math.min(e.cellPosition.col,t.cellPosition.col),i=Math.max(e.cellPosition.col,t.cellPosition.col),s=[];return n.forEach(l=>{if(l.cellType==="cell"&&l.cellPosition&&l.groupId===e.groupId){const{row:u,col:y}=l.cellPosition;u>=o&&u<=r&&y>=a&&y<=i&&s.push(l.id)}}),s},Ae=(e,t,n)=>{if(n==="set")if(t)setTimeout(()=>{try{e.currentTarget.setPointerCapture(e.pointerId)}catch{console.debug("iPhone pointer capture failed, continuing without capture")}},0);else try{e.currentTarget.setPointerCapture(e.pointerId)}catch{}else try{e.currentTarget.releasePointerCapture(e.pointerId)}catch{}},bt=({isViewPage:e=!1})=>{const{textObjects:t,imageObjects:n,updateTextObject:o,updateImageObject:r,deleteTextObject:a,deleteImageObject:i,addTextObject:s,addImageObject:l,settings:u}=Se(),{selectedObjectId:y,hoveredObjectId:b,currentTool:C,setSelectedObjectId:h,setHoveredObjectId:p}=De(),{updatePointerEventTime:M,isGhostClick:W,isIPhone:G}=at(),{dragState:D,startDrag:N,updateDragPosition:K,endDrag:j,isDraggingObject:U}=ot(),{resizeState:g,startResize:V,updateResize:ee,endResize:_,isResizingObject:J}=it(),{editingObjectId:X,editingText:H,startInlineEdit:P,finishInlineEdit:E,cancelInlineEdit:z,updateEditingText:w}=st(o,h,e),{handleClipboardPaste:L}=ct(l,u),{handleDuplicateObject:S,handleDeleteObject:O,handleBulkClearCellText:re}=lt(t,n,a,i,s,l,o,h),[Q,c]=f.useState({clickCount:0,clickTimer:null}),m=f.useCallback(d=>{if(!X){if(d.ctrlKey&&d.key==="v"){try{d.preventDefault()}catch(A){console.debug("preventDefault failed in global keydown handler:",A)}L();return}if(!e){if(d.ctrlKey&&d.key==="d"){try{d.preventDefault()}catch(A){console.debug("preventDefault failed in global keydown handler:",A)}y&&S(y)}if(d.key==="Delete"){try{d.preventDefault()}catch(B){console.debug("preventDefault failed in global keydown handler:",B)}if(fe.getState().getSelectedCells().length>0){re();return}y&&O(y)}}}},[X,y,e,S,O,L,re]),x=f.useCallback((d,A)=>{var Z;M(d.timeStamp),d.stopPropagation();const B=G();if((!B||d.pointerType!=="touch")&&d.preventDefault(),X){E();return}const Y=t.find(te=>te.id===A)||n.find(te=>te.id===A);if(!Y||(h(A),p(null),!((Z=Y.permissions)!=null&&Z.movable)))return;Ae(d,B,"set");const F=d.currentTarget.getBoundingClientRect(),$={x:d.clientX-F.left,y:d.clientY-F.top};N(A,$,{x:Y.x,y:Y.y})},[X,E,t,n,h,p,M,G,N]),v=f.useCallback((d,A,B)=>{var F;d.stopPropagation(),d.preventDefault();const Y=t.find($=>$.id===B)||n.find($=>$.id===B);!Y||!((F=Y.permissions)!=null&&F.resizable)||V(B,A,{x:d.clientX,y:d.clientY},{width:Y.width,height:Y.height},{x:Y.x,y:Y.y})},[t,n,V]),T=f.useCallback(d=>{var A,B,Y,F;if(D.isDragging&&D.draggedObjectId){const $=d.currentTarget.closest("[data-canvas-container]");if(!$)return;const Z=Pe(d.clientX,d.clientY,$),te=He($),ce=ht(Z,D.offset,te),oe=((A=u==null?void 0:u.admin)==null?void 0:A.gridSnapEnabled)??!1,ue=((B=u==null?void 0:u.admin)==null?void 0:B.gridSize)??32,{position:le}=Ee(ce,void 0,oe,ue),ne=t.find(me=>me.id===D.draggedObjectId)||n.find(me=>me.id===D.draggedObjectId),{position:he}=Oe(le,void 0,ne?{x:ne.x,y:ne.y}:void 0);K(he)}if(g.isResizing&&g.resizedObjectId){const $=d.currentTarget.closest("[data-canvas-container]");if(!$)return;const Z=Pe(d.clientX,d.clientY,$),te=Pe(g.startPosition.x,g.startPosition.y,$),ce=ft(Z,te),oe=n.find(Ue=>Ue.id===g.resizedObjectId),ue=(oe==null?void 0:oe.maintainAspectRatio)||!1,le=oe?g.startSize.width/g.startSize.height:1,ne=gt({handle:g.resizeHandle,deltaX:ce.x,deltaY:ce.y,startSize:g.startSize,startPosition:g.startObjectPosition,maintainAspectRatio:ue,originalAspectRatio:le}),he=((Y=u==null?void 0:u.admin)==null?void 0:Y.gridSnapEnabled)??!1,me=((F=u==null?void 0:u.admin)==null?void 0:F.gridSize)??32,{position:$e,size:Ke}=Ee({x:ne.newX,y:ne.newY},{width:ne.newWidth,height:ne.newHeight},he,me),ze=Oe($e,Ke);ze.size&&ee(ze.size,ze.position)}},[D,g,t,n,u,K,ee]),R=f.useCallback(d=>{if(Ae(d,G(),"release"),D.isDragging&&D.draggedObjectId){const A=D.currentPosition,B=t.find(F=>F.id===D.draggedObjectId),Y=n.find(F=>F.id===D.draggedObjectId);B?o(D.draggedObjectId,A).catch(F=>{console.error("Failed to update text object position:",F)}):Y&&r(D.draggedObjectId,A).catch(F=>{console.error("Failed to update image object position:",F)}),j()}if(g.isResizing&&g.resizedObjectId){const A=g.currentSize,B=g.currentPosition;if(A&&B){const Y=t.find(Z=>Z.id===g.resizedObjectId),F=n.find(Z=>Z.id===g.resizedObjectId),$={x:B.x,y:B.y,width:A.width,height:A.height};Y?o(g.resizedObjectId,$).catch(Z=>{console.error("Failed to update text object size/position:",Z)}):F&&r(g.resizedObjectId,$).catch(Z=>{console.error("Failed to update image object size/position:",Z)})}_()}},[D,g,t,n,o,r,j,_,G]),I=f.useCallback((d,A)=>{if(W(d.timeStamp))return;const B=t.find(F=>F.id===A),Y=(B==null?void 0:B.cellType)==="cell";if(!e&&C==="select"&&!Y){const{clearSelection:F}=fe.getState();F(),h(A),d&&d.stopPropagation()}},[C,e,h,t,W]),q=f.useCallback(d=>{if(W(d.timeStamp))return;if(d.currentTarget.focus(),X){E();return}if(!e&&C==="select"){if(d.target===d.currentTarget){h(null);const{clearSelection:B}=fe.getState();B()}}else if(e&&d.target===d.currentTarget){h(null);const{clearSelection:B}=fe.getState();B()}},[X,E,h,e,C,W]),de=f.useCallback((d,A)=>{if(C!=="select")return;if(X&&X!==d.id&&E(),d.cellType==="cell"){const{selectCell:F,selectCellsInRange:$,getSelectedCells:Z}=fe.getState(),te=Q.clickCount+1;if(Q.clickTimer&&clearTimeout(Q.clickTimer),te===2)P(d),c({clickCount:0,clickTimer:null});else{const ce=A.ctrlKey||A.metaKey,oe=A.shiftKey;if(oe){const le=Z();if(le.length>0){const ne=t.find(he=>he.id===le[le.length-1]);if(ne&&ne.cellType==="cell"&&ne.cellPosition&&d.cellPosition){const he=xt(ne,d,t);$(he)}}else F(d.id,!1)}else ce?F(d.id,!0):F(d.id,!1);!ce&&!oe&&h(null);const ue=setTimeout(()=>{c({clickCount:0,clickTimer:null})},300);c({clickCount:te,clickTimer:ue})}return}const Y=Q.clickCount+1;if(Q.clickTimer&&clearTimeout(Q.clickTimer),Y===3)P(d),c({clickCount:0,clickTimer:null});else{I(A,d.id);const F=setTimeout(()=>{c({clickCount:0,clickTimer:null})},500);c({clickCount:Y,clickTimer:F})}},[C,X,E,P,Q,t,h,I]);return k.jsx("div",{className:"absolute inset-0",tabIndex:0,onClick:q,onKeyDown:m,onPointerMove:T,onPointerUp:R,onPointerLeave:R,onContextMenu:pt,style:{touchAction:"none",pointerEvents:"auto",outline:"none"},children:[...t,...n].sort((d,A)=>(d.zIndex||0)-(A.zIndex||0)).map(d=>{const A="text"in d,B="src"in d,Y=U(d.id),F=J(d.id),$=Y?D.currentPosition.x:F&&g.currentPosition?g.currentPosition.x:d.x,Z=Y?D.currentPosition.y:F&&g.currentPosition?g.currentPosition.y:d.y,te=F&&g.currentSize?g.currentSize.width:d.width,ce=F&&g.currentSize?g.currentSize.height:d.height,oe=y===d.id,ue=b===d.id&&!e;return A?k.jsx(nt,{obj:d,isSelected:oe,isHovered:ue,isViewPage:e,isDragging:Y,isResizing:F,currentX:$,currentY:Z,currentWidth:te,currentHeight:ce,currentTool:C,editingObjectId:X,editingText:H,onTextBoxClick:de,onObjectClick:I,onPointerDown:x,onResizePointerDown:v,onMouseEnter:()=>p(d.id),onMouseLeave:()=>p(null),onEditingTextChange:w,onFinishEdit:E,onKeyDown:le=>mt(le,E,z),updateTextObject:o},d.id):B?k.jsx(rt,{obj:d,isSelected:oe,isHovered:ue,isViewPage:e,isDragging:Y,currentX:$,currentY:Z,currentWidth:te,currentHeight:ce,currentTool:C,editingObjectId:X,onObjectClick:I,onPointerDown:x,onResizePointerDown:v,onMouseEnter:()=>p(d.id),onMouseLeave:()=>p(null)},d.id):null})})},wt=({isViewPage:e=!1})=>null;function Me(e,t,n,o=r=>r){return e*o(.5-t*(.5-n))}function yt(e){return[-e[0],-e[1]]}function ae(e,t){return[e[0]+t[0],e[1]+t[1]]}function ie(e,t){return[e[0]-t[0],e[1]-t[1]]}function se(e,t){return[e[0]*t,e[1]*t]}function Ct(e,t){return[e[0]/t,e[1]/t]}function xe(e){return[e[1],-e[0]]}function Le(e,t){return e[0]*t[0]+e[1]*t[1]}function kt(e,t){return e[0]===t[0]&&e[1]===t[1]}function vt(e){return Math.hypot(e[0],e[1])}function St(e){return e[0]*e[0]+e[1]*e[1]}function Fe(e,t){return St(ie(e,t))}function Xe(e){return Ct(e,vt(e))}function zt(e,t){return Math.hypot(e[1]-t[1],e[0]-t[0])}function be(e,t,n){let o=Math.sin(n),r=Math.cos(n),a=e[0]-t[0],i=e[1]-t[1],s=a*r-i*o,l=a*o+i*r;return[s+t[0],l+t[1]]}function Te(e,t,n){return ae(e,se(ie(t,e),n))}function We(e,t,n){return ae(e,se(t,n))}var{min:ge,PI:Pt}=Math,je=.275,we=Pt+1e-4;function Tt(e,t={}){let{size:n=16,smoothing:o=.5,thinning:r=.5,simulatePressure:a=!0,easing:i=w=>w,start:s={},end:l={},last:u=!1}=t,{cap:y=!0,easing:b=w=>w*(2-w)}=s,{cap:C=!0,easing:h=w=>--w*w*w+1}=l;if(e.length===0||n<=0)return[];let p=e[e.length-1].runningLength,M=s.taper===!1?0:s.taper===!0?Math.max(n,p):s.taper,W=l.taper===!1?0:l.taper===!0?Math.max(n,p):l.taper,G=Math.pow(n*o,2),D=[],N=[],K=e.slice(0,10).reduce((w,L)=>{let S=L.pressure;if(a){let O=ge(1,L.distance/n),re=ge(1,1-O);S=ge(1,w+(re-w)*(O*je))}return(w+S)/2},e[0].pressure),j=Me(n,r,e[e.length-1].pressure,i),U,g=e[0].vector,V=e[0].point,ee=V,_=V,J=ee,X=!1;for(let w=0;w<e.length;w++){let{pressure:L}=e[w],{point:S,vector:O,distance:re,runningLength:Q}=e[w];if(w<e.length-1&&p-Q<3)continue;if(r){if(a){let q=ge(1,re/n),de=ge(1,1-q);L=ge(1,K+(de-K)*(q*je))}j=Me(n,r,L,i)}else j=n/2;U===void 0&&(U=j);let c=Q<M?b(Q/M):1,m=p-Q<W?h((p-Q)/W):1;j=Math.max(.01,j*Math.min(c,m));let x=(w<e.length-1?e[w+1]:e[w]).vector,v=w<e.length-1?Le(O,x):1,T=Le(O,g)<0&&!X,R=v!==null&&v<0;if(T||R){let q=se(xe(g),j);for(let de=1/13,d=0;d<=1;d+=de)_=be(ie(S,q),S,we*d),D.push(_),J=be(ae(S,q),S,we*-d),N.push(J);V=_,ee=J,R&&(X=!0);continue}if(X=!1,w===e.length-1){let q=se(xe(O),j);D.push(ie(S,q)),N.push(ae(S,q));continue}let I=se(xe(Te(x,O,v)),j);_=ie(S,I),(w<=1||Fe(V,_)>G)&&(D.push(_),V=_),J=ae(S,I),(w<=1||Fe(ee,J)>G)&&(N.push(J),ee=J),K=L,g=O}let H=e[0].point.slice(0,2),P=e.length>1?e[e.length-1].point.slice(0,2):ae(e[0].point,[1,1]),E=[],z=[];if(e.length===1){if(!(M||W)||u){let w=We(H,Xe(xe(ie(H,P))),-(U||j)),L=[];for(let S=1/13,O=S;O<=1;O+=S)L.push(be(w,H,we*2*O));return L}}else{if(!(M||W&&e.length===1))if(y)for(let L=1/13,S=L;S<=1;S+=L){let O=be(N[0],H,we*S);E.push(O)}else{let L=ie(D[0],N[0]),S=se(L,.5),O=se(L,.51);E.push(ie(H,S),ie(H,O),ae(H,O),ae(H,S))}let w=xe(yt(e[e.length-1].vector));if(W||M&&e.length===1)z.push(P);else if(C){let L=We(P,w,j);for(let S=1/29,O=S;O<1;O+=S)z.push(be(L,P,we*3*O))}else z.push(ae(P,se(w,j)),ae(P,se(w,j*.99)),ie(P,se(w,j*.99)),ie(P,se(w,j)))}return D.concat(z,N.reverse(),E)}function Dt(e,t={}){var n;let{streamline:o=.5,size:r=16,last:a=!1}=t;if(e.length===0)return[];let i=.15+(1-o)*.85,s=Array.isArray(e[0])?e:e.map(({x:h,y:p,pressure:M=.5})=>[h,p,M]);if(s.length===2){let h=s[1];s=s.slice(0,-1);for(let p=1;p<5;p++)s.push(Te(s[0],h,p/4))}s.length===1&&(s=[...s,[...ae(s[0],[1,1]),...s[0].slice(2)]]);let l=[{point:[s[0][0],s[0][1]],pressure:s[0][2]>=0?s[0][2]:.25,vector:[1,1],distance:0,runningLength:0}],u=!1,y=0,b=l[0],C=s.length-1;for(let h=1;h<s.length;h++){let p=a&&h===C?s[h].slice(0,2):Te(b.point,s[h],i);if(kt(b.point,p))continue;let M=zt(p,b.point);if(y+=M,h<C&&!u){if(y<r)continue;u=!0}b={point:p,pressure:s[h][2]>=0?s[h][2]:.5,vector:Xe(ie(b.point,p)),distance:M,runningLength:y},l.push(b)}return l[0].vector=((n=l[1])==null?void 0:n.vector)||[0,0],l}function Be(e,t={}){return Tt(Dt(e,t),t)}const Rt=()=>{var Q;const e=f.useRef(null),t=f.useRef(!1),n=f.useRef(null),o=f.useRef(!1),r=f.useRef(null),a=f.useRef(!1),i=f.useRef(null),s=f.useRef(!0),l=f.useRef(null),u=f.useRef(null),{currentStroke:y,currentPressureStroke:b,isDrawing:C,penColor:h,penWidth:p,usePerfectFreehand:M,addPoint:W,startStroke:G,endStroke:D,clearCurrentStroke:N}=Ve(),{drawObjects:K,settings:j,isLoading:U}=Se(),{currentTool:g,setCurrentTool:V}=De();f.useEffect(()=>{const c=navigator.userAgent.toLowerCase(),m=/iphone|ipad|ipod/.test(c),x=/safari/.test(c)&&!/chrome/.test(c);a.current=m||x},[]);const ee=f.useCallback((c="mouse")=>{const m={size:p*2,thinning:.5,smoothing:.5,streamline:.5,easing:x=>x,start:{taper:0,easing:x=>x,cap:!0},end:{taper:100,easing:x=>x,cap:!0}};return c==="pen"?{...m,thinning:.7,smoothing:.3,streamline:.3}:c==="touch"?{...m,thinning:.4,smoothing:.7,streamline:.7,size:p*2.5}:m},[p]),_=f.useCallback((c,m,x)=>{if(m.length<2)return;c.save(),c.fillStyle=x,c.beginPath();const[v]=m;c.moveTo(v[0],v[1]);for(let T=1;T<m.length;T++){const[R,I]=m[T],[q,de]=m[T-1],d=(q+R)/2,A=(de+I)/2;c.quadraticCurveTo(q,de,d,A)}c.closePath(),c.fill(),c.restore()},[]),J=f.useCallback(()=>{var c;n.current&&(clearTimeout(n.current),n.current=null),(c=j==null?void 0:j.admin)!=null&&c.autoToolSwitch&&(n.current=setTimeout(()=>{V("select"),n.current=null},2e3))},[(Q=j==null?void 0:j.admin)==null?void 0:Q.autoToolSwitch,V]),X=f.useCallback(()=>{const c=e.current;if(!c||!s.current)return;const m=c.parentElement;if(!m)return;const x=m.offsetWidth,v=m.offsetHeight;(c.width!==x||c.height!==v)&&(c.width=x,c.height=v,!o.current&&s.current&&(o.current=!0,u.current=requestAnimationFrame(()=>{o.current&&!U&&s.current&&(z(),o.current=!1),u.current=null})))},[U]),H=f.useCallback((c,m)=>{const x=e.current;if(!x)return{x:0,y:0};const v=x.getBoundingClientRect(),T=(c-v.left)/v.width*2160,R=(m-v.top)/v.height*3840;return{x:T,y:R}},[]),P=f.useCallback((c,m)=>{const x=e.current;return x?{x:c/2160*x.width,y:m/3840*x.height}:{x:0,y:0}},[]),E=f.useCallback(async(c,m)=>{for(const v of K)for(let T=0;T<v.points.length;T+=2)if(Math.sqrt((v.points[T]-c)**2+(v.points[T+1]-m)**2)<=20)try{const I=Ze(_e,`drawObjects/${v.id}`);await Je(I);return}catch(I){console.error("‚ùå DrawLayer: Failed to erase stroke:",I)}},[K]),z=f.useCallback(()=>{const c=e.current;if(!c)return;const m=c.getContext("2d");if(m&&!(c.width===0||c.height===0)&&(m.clearRect(0,0,c.width,c.height),m.lineCap="round",m.lineJoin="round",K.forEach(x=>{var v;if(!(x.points.length<4))if(M&&x.usePerfectFreehand)try{const T=[];for(let R=0;R<x.points.length;R+=2){const I=P(x.points[R],x.points[R+1]);T.push([I.x,I.y,((v=x.pressure)==null?void 0:v[R/2])||.5])}if(T.length>=2){const R=ee(x.inputType||"mouse");R.size=x.width*2;const I=Be(T,R);_(m,I,x.color)}}catch(T){console.warn("üö´ perfect-freehand Î†åÎçîÎßÅ Ïã§Ìå®, Í∏∞Î≥∏ Î†åÎçîÎßÅÏúºÎ°ú ÎåÄÏ≤¥:",T),m.beginPath(),m.strokeStyle=x.color,m.lineWidth=x.width;const R=P(x.points[0],x.points[1]);m.moveTo(R.x,R.y);for(let I=2;I<x.points.length;I+=2){const q=P(x.points[I],x.points[I+1]);m.lineTo(q.x,q.y)}m.stroke()}else{m.beginPath(),m.strokeStyle=x.color,m.lineWidth=x.width;const T=P(x.points[0],x.points[1]);m.moveTo(T.x,T.y);for(let R=2;R<x.points.length;R+=2){const I=P(x.points[R],x.points[R+1]);m.lineTo(I.x,I.y)}m.stroke()}}),C&&y.length>=4))if(M&&b.length>=2)try{const x=b.map(I=>{const q=P(I.x,I.y);return[q.x,q.y,I.pressure||.5]}),v=r.current&&a.current?"touch":"mouse",T=ee(v),R=Be(x,T);_(m,R,h)}catch(x){console.warn("üö´ ÌòÑÏû¨ Ïä§Ìä∏Î°úÌÅ¨ perfect-freehand Î†åÎçîÎßÅ Ïã§Ìå®:",x),m.beginPath(),m.strokeStyle=h,m.lineWidth=p;const v=P(y[0],y[1]);m.moveTo(v.x,v.y);for(let T=2;T<y.length;T+=2){const R=P(y[T],y[T+1]);m.lineTo(R.x,R.y)}m.stroke()}else{m.beginPath(),m.strokeStyle=h,m.lineWidth=p;const x=P(y[0],y[1]);m.moveTo(x.x,x.y);for(let v=2;v<y.length;v+=2){const T=P(y[v],y[v+1]);m.lineTo(T.x,T.y)}m.stroke()}},[K,y,b,C,h,p,M,P,U,ee,_]),w=f.useCallback(c=>{const m=navigator.userAgent.toLowerCase(),x=/iphone/.test(m),v=/ipad/.test(m);if(a.current){if(x)return!0;if(v&&(g==="eraser"&&r.current!==null&&c.pointerType==="touch"||g==="pen"&&c.pointerType!=="pen"&&c.pointerType!=="touch"&&c.pointerType!=="mouse"))return!1}return!0},[g]),L=f.useCallback(c=>{if(g!=="pen"&&g!=="eraser"||!w(c))return;const m=navigator.userAgent.toLowerCase(),x=/iphone/.test(m);if(!x&&r.current!==null&&r.current!==c.pointerId)return;(!x||c.pointerType!=="touch")&&c.preventDefault(),c.stopPropagation(),r.current=c.pointerId,n.current&&(clearTimeout(n.current),n.current=null),i.current&&(clearTimeout(i.current),i.current=null);const v=H(c.clientX,c.clientY);if(g==="pen"){G();const T=c.pressure||(x?.7:.5),R=c.tiltX||0,I=c.tiltY||0;W(v.x,v.y,T,R,I),z()}else g==="eraser"&&(t.current=!0,E(v.x,v.y))},[g,H,G,W,z,E,w]),S=f.useCallback(c=>{const m=navigator.userAgent.toLowerCase();if(!(!/iphone/.test(m)&&r.current!==c.pointerId)){if(g==="pen"&&C){c.preventDefault();const v=H(c.clientX,c.clientY),T=c.pressure||.5,R=c.tiltX||0,I=c.tiltY||0;W(v.x,v.y,T,R,I),z()}else if(g==="eraser"&&t.current){c.preventDefault();const v=H(c.clientX,c.clientY);E(v.x,v.y)}}},[C,g,H,W,z,E]),O=f.useCallback(async c=>{const m=navigator.userAgent.toLowerCase();if(!(!/iphone/.test(m)&&r.current!==c.pointerId)){if(C&&g==="pen"){if(D(),y.length>=4){const v=c.pointerType==="pen"?"pen":c.pointerType==="touch"?"touch":"mouse",T=b.map(I=>I.pressure||.5),R={points:y,color:h,width:p,createdAt:new Date().toISOString(),lastModified:Date.now(),usePerfectFreehand:M,pressure:T,inputType:v};try{await Qe(R)}catch(I){console.error("‚ùå DrawLayer: Failed to save stroke:",I)}}N(),z(),J()}g==="eraser"&&t.current&&(t.current=!1,J()),r.current=null,a.current&&c.pointerType==="touch"&&(i.current=setTimeout(()=>{i.current=null},100))}},[C,g,y,D,h,p,N,z,J]),re=f.useCallback(c=>{r.current===c.pointerId&&(C&&(D(),N(),z()),t.current&&(t.current=!1),r.current=null)},[C,D,N,z]);return f.useEffect(()=>{X();const c=()=>{s.current&&setTimeout(X,100)};return window.addEventListener("resize",c),()=>{window.removeEventListener("resize",c),s.current=!1,u.current&&(cancelAnimationFrame(u.current),u.current=null),o.current=!1}},[X]),f.useEffect(()=>{if(!U&&s.current)return l.current=setTimeout(()=>{s.current&&z(),l.current=null},100),()=>{l.current&&(clearTimeout(l.current),l.current=null)}},[U]),f.useEffect(()=>{U||z()},[K,U]),f.useEffect(()=>{(g==="pen"||g==="eraser")&&n.current&&(clearTimeout(n.current),n.current=null)},[g]),f.useEffect(()=>{C&&z()},[y,C]),f.useEffect(()=>()=>{s.current=!1,n.current&&(clearTimeout(n.current),n.current=null),i.current&&(clearTimeout(i.current),i.current=null),l.current&&(clearTimeout(l.current),l.current=null),u.current&&(cancelAnimationFrame(u.current),u.current=null),o.current=!1,r.current=null},[]),k.jsx("canvas",{ref:e,className:"absolute top-0 left-0 w-full h-full",onPointerDown:g==="pen"||g==="eraser"?L:void 0,onPointerMove:g==="pen"||g==="eraser"?S:void 0,onPointerUp:g==="pen"||g==="eraser"?O:void 0,onPointerCancel:g==="pen"||g==="eraser"?re:void 0,onPointerLeave:g==="pen"||g==="eraser"?O:void 0,onContextMenu:c=>c.preventDefault(),style:{position:"absolute",top:0,left:0,width:"100%",height:"100%",touchAction:"none",cursor:g==="pen"?"crosshair":g==="eraser"?"grab":"default",pointerEvents:g==="pen"||g==="eraser"?"auto":"none",WebkitTouchCallout:"none",WebkitUserSelect:"none",WebkitTapHighlightColor:"transparent"}})},Ne=ke.memo(({gridEnabled:e,gridSize:t,canvasWidth:n,canvasHeight:o})=>{if(!e)return null;const r=[],a=[];for(let i=0;i<=n;i+=t)r.push(k.jsx("line",{x1:i,y1:0,x2:i,y2:o,stroke:"#e5e7eb",strokeWidth:1,opacity:.5},`v-${i}`));for(let i=0;i<=o;i+=t)a.push(k.jsx("line",{x1:0,y1:i,x2:n,y2:i,stroke:"#e5e7eb",strokeWidth:1,opacity:.5},`h-${i}`));return k.jsxs("svg",{className:"absolute inset-0 pointer-events-none",width:n,height:o,style:{zIndex:1},children:[r,a]})});Ne.displayName="GridLayer";const It=e=>e.split(`
`).filter(t=>t.trim()).map(t=>t.split("	")),Et=()=>{var C;const{settings:e}=Se(),[t,n]=ke.useState(""),[o,r]=ke.useState(!1);if(ke.useEffect(()=>{const h=p=>{n(p.detail.data),r(p.detail.show)};return window.addEventListener("excel-preview-update",h),()=>{window.removeEventListener("excel-preview-update",h)}},[]),!o||!t.trim())return null;const a={excelPasteSettings:((C=e==null?void 0:e.admin)==null?void 0:C.excelPasteSettings)??{startPosition:{x:100,y:100},cellWidth:120,cellHeight:40,fontSize:14}},i=It(t),{startPosition:s,cellWidth:l,cellHeight:u}=a.excelPasteSettings,y=Math.max(...i.map(h=>h.length))*l,b=i.length*u;return k.jsxs("div",{style:{position:"absolute",top:0,left:0,right:0,bottom:0,pointerEvents:"none",zIndex:15},children:[k.jsx("div",{style:{position:"absolute",left:s.x,top:s.y,width:y,height:b,border:"3px dashed #fbbf24",backgroundColor:"rgba(251, 191, 36, 0.1)",borderRadius:"4px",boxShadow:"0 2px 8px rgba(251, 191, 36, 0.3)"}}),i.map((h,p)=>h.map((M,W)=>k.jsx("div",{style:{position:"absolute",left:s.x+W*l,top:s.y+p*u,width:l,height:u,border:"1px solid rgba(251, 191, 36, 0.4)",backgroundColor:"rgba(251, 191, 36, 0.05)",display:"flex",alignItems:"center",justifyContent:"center",fontSize:`${a.excelPasteSettings.fontSize}px`,color:"rgba(251, 191, 36, 0.8)",fontWeight:"bold",overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap",padding:"2px"},children:M},`preview-${p}-${W}`))),k.jsxs("div",{style:{position:"absolute",left:s.x,top:s.y-30,backgroundColor:"rgba(251, 191, 36, 0.9)",color:"#ffffff",padding:"4px 8px",borderRadius:"4px",fontSize:"12px",fontWeight:"bold",whiteSpace:"nowrap",boxShadow:"0 2px 4px rgba(0, 0, 0, 0.2)"},children:["üìä ÎØ∏Î¶¨Î≥¥Í∏∞: ",i.length,"Ìñâ √ó ",Math.max(...i.map(h=>h.length)),"Ïó¥"]})]})},ye=2160,Ce=3840,Mt=({isViewPage:e=!1})=>{var J,X,H,P;const t=f.useRef(null),n=f.useRef(null),[o,r]=f.useState(.15),{zoom:a,viewOffset:i,setZoom:s,zoomAtPoint:l,currentTool:u}=De(),{floorImage:y,settings:b}=Se(),C={gridVisible:((J=b==null?void 0:b.admin)==null?void 0:J.gridVisible)??!0,gridSize:((X=b==null?void 0:b.admin)==null?void 0:X.gridSize)??32},h=f.useCallback(E=>{E.ctrlKey},[]);f.useEffect(()=>{a<.04&&s(1)},[a,s]),f.useEffect(()=>{const E=z=>{if(z.ctrlKey){try{z.preventDefault()}catch(re){console.debug("preventDefault failed in global wheel handler:",re)}if(!t.current||!n.current)return;const w=t.current.getBoundingClientRect(),L=z.clientX-w.left,S=z.clientY-w.top,O=-z.deltaY;l(O,L,S,w)}};return window.addEventListener("wheel",E,{passive:!1}),()=>{window.removeEventListener("wheel",E)}},[l]),f.useEffect(()=>{const E=z=>{if(z.ctrlKey&&(z.key==="+"||z.key==="=")){try{z.preventDefault()}catch(O){console.debug("preventDefault failed in global keydown handler:",O)}if(!t.current||!n.current)return;const w=t.current.getBoundingClientRect(),L=w.width/2,S=w.height/2;l(120,L,S,w)}if(z.ctrlKey&&z.key==="-"){try{z.preventDefault()}catch(O){console.debug("preventDefault failed in global keydown handler:",O)}if(!t.current||!n.current)return;const w=t.current.getBoundingClientRect(),L=w.width/2,S=w.height/2;l(-120,L,S,w)}};return window.addEventListener("keydown",E),()=>{window.removeEventListener("keydown",E)}},[l]),f.useEffect(()=>{const E=()=>{if(t.current){const w=t.current,L=w.clientWidth,S=w.clientHeight;if(L<=0||S<=0){r(.15);return}const O=L/ye,re=S/Ce,Q=Math.min(O,re);r(Math.max(.1,Q))}},z=setTimeout(E,100);return window.addEventListener("resize",E),()=>{clearTimeout(z),window.removeEventListener("resize",E)}},[a]);const p=o*a,M=ye*p,W=Ce*p,G=((H=t.current)==null?void 0:H.clientWidth)||0,D=((P=t.current)==null?void 0:P.clientHeight)||0,N=200,K=M>G,j=W>D,U=K?M+N*2:G,g=j?W+N*2:D,V=E=>{try{E.preventDefault(),E.stopPropagation()}catch(z){console.debug("preventDefault failed in Canvas context menu:",z)}return!1},ee=E=>{if(E.touches.length===1){const z=setTimeout(()=>{try{E.preventDefault()}catch{}},200),w=()=>{clearTimeout(z),document.removeEventListener("touchend",w),document.removeEventListener("touchmove",w)};document.addEventListener("touchend",w,{once:!0}),document.addEventListener("touchmove",w,{once:!0})}},_=()=>u==="pen"||u==="eraser"?"crosshair":"default";return k.jsxs("div",{ref:t,onWheel:h,style:{position:"relative",width:"100%",height:"100%",overflowX:K?"auto":"hidden",overflowY:j?"auto":"hidden",backgroundColor:"transparent",cursor:_()},children:[(K||j)&&k.jsx("div",{style:{position:"absolute",top:0,left:0,width:U,height:g,pointerEvents:"none",zIndex:1}}),k.jsxs("div",{ref:n,"data-canvas-container":!0,style:{position:"absolute",backgroundColor:"#ffffff",border:"1px solid #d1d5db",boxShadow:"0 4px 6px -1px rgba(0, 0, 0, 0.1)",width:ye,height:Ce,transform:`translate(${i.x}px, ${i.y}px) scale(${p})`,transformOrigin:"center center",left:K||j?U/2:"50%",top:K||j?g/2:"50%",marginLeft:`-${ye/2}px`,marginTop:`-${Ce/2}px`,zIndex:10},onContextMenu:V,onTouchStart:ee,children:[y?k.jsx("div",{style:{position:"absolute",top:0,left:0,right:0,bottom:0,backgroundImage:`url(${y.path})`,backgroundSize:"cover",backgroundPosition:"center",backgroundRepeat:"no-repeat",zIndex:0}}):k.jsx("div",{style:{position:"absolute",top:0,left:0,right:0,bottom:0,backgroundColor:"#f9fafb",display:"flex",alignItems:"center",justifyContent:"center",zIndex:0},children:k.jsxs("div",{style:{color:"#9ca3af",fontSize:"24px",textAlign:"center"},children:["Board7 Canvas",k.jsx("br",{}),k.jsx("span",{style:{fontSize:"16px"},children:"2160 x 3840"})]})}),k.jsxs("div",{style:{position:"absolute",top:0,left:0,right:0,bottom:0,zIndex:100},children:[k.jsx(Ne,{gridEnabled:C.gridVisible,gridSize:C.gridSize,canvasWidth:ye,canvasHeight:Ce}),k.jsx(wt,{}),k.jsx(bt,{isViewPage:e}),k.jsx(Et,{})]}),k.jsx("div",{style:{position:"absolute",top:0,left:0,right:0,bottom:0,zIndex:1e4,pointerEvents:u==="pen"||u==="eraser"?"auto":"none"},children:k.jsx(Rt,{isViewPage:e})})]}),k.jsxs("div",{style:{position:"absolute",bottom:"16px",left:"16px",backgroundColor:"rgba(0, 0, 0, 0.5)",color:"#ffffff",padding:"4px 12px",borderRadius:"4px",fontSize:"14px",zIndex:1e3},children:[Math.round(o*a*100),"%"]})]})};export{Mt as C,De as a,Ve as b,fe as u};
