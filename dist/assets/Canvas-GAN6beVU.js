import{r as g,g as mt,R as Oe,j as k}from"./index-CWBKnHgC.js";import{p as Le,r as Q,d as ee,s as me,g as nt,u as rt,b as Ee,o as ve}from"./PasswordGate-YHpFH4KU.js";const bt={},Be=e=>{let t;const n=new Set,r=(p,m)=>{const w=typeof p=="function"?p(t):p;if(!Object.is(w,t)){const d=t;t=m??(typeof w!="object"||w===null)?w:Object.assign({},t,w),n.forEach(h=>h(t,d))}},o=()=>t,c={setState:r,getState:o,getInitialState:()=>l,subscribe:p=>(n.add(p),()=>n.delete(p)),destroy:()=>{(bt?"production":void 0)!=="production"&&console.warn("[DEPRECATED] The `destroy` method will be unsupported in a future version. Instead use unsubscribe function returned by subscribe. Everything will be garbage-collected if store is garbage-collected."),n.clear()}},l=t=e(r,o,c);return c},wt=e=>e?Be(e):Be;var ot={exports:{}},it={},st={exports:{}},at={};/**
 * @license React
 * use-sync-external-store-shim.production.js
 *
 * Copyright (c) Meta Platforms, Inc. and affiliates.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE file in the root directory of this source tree.
 */var xe=g;function xt(e,t){return e===t&&(e!==0||1/e===1/t)||e!==e&&t!==t}var yt=typeof Object.is=="function"?Object.is:xt,vt=xe.useState,Ct=xe.useEffect,kt=xe.useLayoutEffect,St=xe.useDebugValue;function zt(e,t){var n=t(),r=vt({inst:{value:n,getSnapshot:t}}),o=r[0].inst,i=r[1];return kt(function(){o.value=n,o.getSnapshot=t,Ae(o)&&i({inst:o})},[e,n,t]),Ct(function(){return Ae(o)&&i({inst:o}),e(function(){Ae(o)&&i({inst:o})})},[e]),St(n),n}function Ae(e){var t=e.getSnapshot;e=e.value;try{var n=t();return!yt(e,n)}catch{return!0}}function Pt(e,t){return t()}var Ot=typeof window>"u"||typeof window.document>"u"||typeof window.document.createElement>"u"?Pt:zt;at.useSyncExternalStore=xe.useSyncExternalStore!==void 0?xe.useSyncExternalStore:Ot;st.exports=at;var Dt=st.exports;/**
 * @license React
 * use-sync-external-store-shim/with-selector.production.js
 *
 * Copyright (c) Meta Platforms, Inc. and affiliates.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE file in the root directory of this source tree.
 */var Te=g,Rt=Dt;function Et(e,t){return e===t&&(e!==0||1/e===1/t)||e!==e&&t!==t}var It=typeof Object.is=="function"?Object.is:Et,Tt=Rt.useSyncExternalStore,jt=Te.useRef,Mt=Te.useEffect,At=Te.useMemo,Wt=Te.useDebugValue;it.useSyncExternalStoreWithSelector=function(e,t,n,r,o){var i=jt(null);if(i.current===null){var s={hasValue:!1,value:null};i.current=s}else s=i.current;i=At(function(){function c(d){if(!l){if(l=!0,p=d,d=r(d),o!==void 0&&s.hasValue){var h=s.value;if(o(h,d))return m=h}return m=d}if(h=m,It(p,d))return h;var O=r(d);return o!==void 0&&o(h,O)?(p=d,h):(p=d,m=O)}var l=!1,p,m,w=n===void 0?null:n;return[function(){return c(t())},w===null?void 0:function(){return c(w())}]},[t,n,r,o]);var a=Tt(e,i[0],i[1]);return Mt(function(){s.hasValue=!0,s.value=a},[a]),Wt(a),a};ot.exports=it;var Lt=ot.exports;const Ft=mt(Lt),ct={},{useDebugValue:$t}=Oe,{useSyncExternalStoreWithSelector:Bt}=Ft;let He=!1;const Ht=e=>e;function Yt(e,t=Ht,n){(ct?"production":void 0)!=="production"&&n&&!He&&(console.warn("[DEPRECATED] Use `createWithEqualityFn` instead of `create` or use `useStoreWithEqualityFn` instead of `useStore`. They can be imported from 'zustand/traditional'. https://github.com/pmndrs/zustand/discussions/1937"),He=!0);const r=Bt(e.subscribe,e.getState,e.getServerState||e.getInitialState,t,n);return $t(r),r}const Ye=e=>{(ct?"production":void 0)!=="production"&&typeof e!="function"&&console.warn("[DEPRECATED] Passing a vanilla store will be unsupported in a future version. Instead use `import { useStore } from 'zustand'`.");const t=typeof e=="function"?wt(e):e,n=(r,o)=>Yt(t,r,o);return Object.assign(n,t),n},be=e=>e?Ye(e):Ye,$e=be((e,t)=>({currentTool:"select",zoom:1,viewOffset:{x:0,y:0},selectedObjectId:null,creationMode:null,hoveredObjectId:null,setCurrentTool:n=>e({currentTool:n}),setZoom:n=>e({zoom:Math.max(.05,Math.min(5,n))}),setViewOffset:n=>e({viewOffset:n}),setSelectedObjectId:n=>e({selectedObjectId:n}),setCreationMode:n=>e({creationMode:n}),setHoveredObjectId:n=>e({hoveredObjectId:n}),zoomIn:()=>e(n=>({zoom:Math.min(5,n.zoom+.1)})),zoomOut:()=>e(n=>({zoom:Math.max(.05,n.zoom-.1)})),zoomAtPoint:(n,r,o,i)=>{const s=t(),a=1.1,c=n>0?Math.min(5,s.zoom*a):Math.max(.05,s.zoom/a);if(c===s.zoom)return;const l=i.height/2,p=o-l,m=c/s.zoom,w=s.viewOffset.x,d=s.viewOffset.y+p*(1-m);e({zoom:c,viewOffset:{x:w,y:d}})},resetZoom:()=>e({zoom:1,viewOffset:{x:0,y:0}}),fitToWindow:()=>e({zoom:1,viewOffset:{x:0,y:0}})}));be(e=>({isDragging:!1,viewCam:{x:0,y:0},snapEnabled:!0,setIsDragging:t=>e({isDragging:t}),setViewCam:t=>e({viewCam:t}),setSnapEnabled:t=>e({snapEnabled:t}),panCanvas:(t,n)=>e(r=>({viewCam:{x:r.viewCam.x+t,y:r.viewCam.y+n}})),resetView:()=>e({viewCam:{x:0,y:0}})}));const _t=be(e=>({currentStroke:[],currentPressureStroke:[],isDrawing:!1,penColor:"#000000",penWidth:4,usePerfectFreehand:!0,lastActionTime:0,defaultColors:["#000000","#FF0000","#00FF00","#0000FF","#FFFF00","#FF00FF","#00FFFF","#FFA500","#800080","#A52A2A"],addPoint:(t,n,r=.5,o=0,i=0)=>e(s=>({currentStroke:[...s.currentStroke,t,n],currentPressureStroke:[...s.currentPressureStroke,{x:t,y:n,pressure:r,tiltX:o,tiltY:i}]})),startStroke:()=>e({isDrawing:!0,currentStroke:[]}),endStroke:()=>e({isDrawing:!1}),clearCurrentStroke:()=>e({currentStroke:[],currentPressureStroke:[]}),setPenColor:t=>e({penColor:t}),setPenWidth:t=>e({penWidth:t}),setUsePerfectFreehand:t=>e({usePerfectFreehand:t}),updateLastActionTime:()=>e({lastActionTime:Date.now()})}));function De(e){return typeof e=="number"&&!isNaN(e)&&isFinite(e)}function Xt(e){return De(e.x)&&De(e.y)}function Nt(e){return De(e.width)&&De(e.height)&&e.width>0&&e.height>0}function _e(e,t=0){return De(e)?e:(console.warn(`Invalid number value: ${e}, using default: ${t}`),t)}function Xe(e){const t={};for(const[n,r]of Object.entries(e))n==="x"||n==="y"?t[n]=_e(r,0):n==="width"||n==="height"?t[n]=_e(r,100):t[n]=r;return t}const Ut=()=>{if(typeof window<"u"){let e=localStorage.getItem("board7_session_id");return e||(e=`user_${Date.now()}_${Math.random().toString(36).substr(2,9)}`,localStorage.setItem("board7_session_id",e)),e}return`server_${Date.now()}_${Math.random().toString(36).substr(2,9)}`},Re=()=>Ut(),Gt=async(e,t,n=Re())=>{try{const r=Q(ee,`textObjects/${e}`),i=(await nt(r)).val();if(!i){const l={...t,id:e,lastModified:Date.now(),modifiedBy:n};return await me(r,l),!0}const s=Date.now(),a=i.lastModified||0;if(t.lastModified&&t.lastModified<a)return console.warn(`LWW: Update rejected for object ${e}. Server timestamp: ${a}, Client timestamp: ${t.lastModified}`),!1;const c={...t,lastModified:s,modifiedBy:n};return await rt(r,c),console.log(`LWW: Object ${e} updated successfully by ${n}`),!0}catch(r){return console.error("LWW update failed:",r),!1}},Kt=async(e,t,n=Re())=>{try{const r=Q(ee,`imageObjects/${e}`),i=(await nt(r)).val();if(!i){const l={...t,id:e,lastModified:Date.now(),modifiedBy:n};return await me(r,l),!0}const s=Date.now(),a=i.lastModified||0;if(t.lastModified&&t.lastModified<a)return console.warn(`LWW: Update rejected for object ${e}. Server timestamp: ${a}, Client timestamp: ${t.lastModified}`),!1;const c={...t,lastModified:s,modifiedBy:n};return await rt(r,c),console.log(`LWW: Object ${e} updated successfully by ${n}`),!0}catch(r){return console.error("LWW update failed:",r),!1}},Vt=async e=>{try{const t=Le(Q(ee,"drawObjects"));if(!t.key)throw new Error("Failed to generate object ID");const n={...e,id:t.key,lastModified:Date.now(),modifiedBy:Re()};return await me(t,n),t.key}catch(t){throw console.error("Error creating draw object:",t),t}},je=be((e,t)=>{let n=[];return{textObjects:[],imageObjects:[],drawObjects:[],floorImage:null,settings:{admin:{autoToolSwitch:!0,gridVisible:!0,gridSize:16,gridSnapEnabled:!0,defaultFontSize:16,defaultBoxWidth:200,defaultBoxHeight:60,objectCreationPosition:{x:260,y:950},defaultCheckboxSettings:{checkedColor:"#22c55e",uncheckedColor:"#f3f4f6",checkedBackgroundColor:"#ffffff",uncheckedBackgroundColor:"#ffffff",checkedBackgroundOpacity:1,uncheckedBackgroundOpacity:1},excelPasteSettings:{startPosition:{x:100,y:100},cellWidth:120,cellHeight:40,fontSize:14,fontColor:"#000000",backgroundColor:"#ffffff",maxRows:50,maxCols:50},passwords:{admin:"1004",view:"1004"}},view:{virtualKeyboardEnabled:!0,touchMode:!0}},isLoading:!1,initializeFirebaseListeners:()=>{t().cleanupFirebaseListeners(),e({isLoading:!0});let r=0;const o=5,i=()=>{r++,r>=o&&e({isLoading:!1})},s=()=>{i()},a=(C,M)=>{i()},c=Q(ee,"textObjects"),l=ve(c,C=>{const M=C.val(),Y=M?Object.values(M):[];e({textObjects:Y}),s()},C=>{a()});n.push(l);const p=Q(ee,"imageObjects"),m=ve(p,C=>{const M=C.val(),Y=M?Object.values(M):[];e({imageObjects:Y}),s()},C=>{a()});n.push(m);const w=Q(ee,"drawObjects"),d=ve(w,C=>{const M=C.val(),Y=M?Object.values(M):[];e({drawObjects:Y}),s()},C=>{a()});n.push(d);const h=Q(ee,"floorImage"),O=ve(h,C=>{const M=C.val();e({floorImage:M}),s()},C=>{a()});n.push(O);const W=Q(ee,"settings"),N=ve(W,C=>{const M=C.val();M&&e({settings:M}),s()},C=>{a()});n.push(N)},cleanupFirebaseListeners:()=>{n.forEach(r=>r()),n=[]},addTextObject:async r=>{const o=Q(ee,"textObjects"),i=Le(o),s=Re(),a={...r,id:i.key,lastModified:Date.now(),modifiedBy:s};return await me(i,a),i.key},updateTextObject:async(r,o)=>{const i=Xe(o);await Gt(r,i)||console.warn(`Failed to update text object ${r} due to LWW conflict`)},deleteTextObject:async r=>{const o=Q(ee,`textObjects/${r}`);await Ee(o)},addImageObject:async r=>{const o=Q(ee,"imageObjects"),i=Le(o),s=Re(),a={...r,id:i.key,lastModified:Date.now(),modifiedBy:s};return await me(i,a),i.key},updateImageObject:async(r,o)=>{const i=Xe(o);await Kt(r,i)||console.warn(`Failed to update image object ${r} due to LWW conflict`)},deleteImageObject:async r=>{const o=Q(ee,`imageObjects/${r}`);await Ee(o)},deleteDrawObject:async r=>{const o=Q(ee,`drawObjects/${r}`);await Ee(o)},setFloorImage:async r=>{const o=Q(ee,"floorImage");await me(o,r)},updateSettings:async(r,o)=>{const i=Q(ee,`settings/${r}`),s=t().settings[r];await me(i,{...s,...o})},initializePasswords:async()=>{t().settings.admin.passwords},updatePassword:async(r,o)=>{if(!o||o.length!==4||!/^\d{4}$/.test(o))throw new Error("패스워드는 4자리 숫자여야 합니다.");const s=t().settings.admin.passwords;await t().updateSettings("admin",{passwords:{...s,[r]:o}})},getPassword:r=>t().settings.admin.passwords[r]||"1004"}});be(e=>({gridEnabled:!1,gridSize:10,snapEnabled:!0,setGridEnabled:t=>e({gridEnabled:t}),setGridSize:t=>e({gridSize:t}),setSnapEnabled:t=>e({snapEnabled:t})}));const Zt=be(e=>({defaultCheckedColor:"#10b981",defaultUncheckedColor:"#f3f4f6",checkedBackgroundColor:"#dcfce7",uncheckedBackgroundColor:"#ffffff",checkedBackgroundOpacity:.8,uncheckedBackgroundOpacity:1,setDefaultCheckedColor:t=>e({defaultCheckedColor:t}),setDefaultUncheckedColor:t=>e({defaultUncheckedColor:t}),setCheckedBackgroundColor:t=>e({checkedBackgroundColor:t}),setUncheckedBackgroundColor:t=>e({uncheckedBackgroundColor:t}),setCheckedBackgroundOpacity:t=>e({checkedBackgroundOpacity:t}),setUncheckedBackgroundOpacity:t=>e({uncheckedBackgroundOpacity:t})})),pe=be((e,t)=>({selectedCellIds:new Set,isDragSelecting:!1,dragStartPoint:null,dragEndPoint:null,selectCell:(n,r=!1)=>{e(o=>{const i=new Set(o.selectedCellIds);return r?i.has(n)?i.delete(n):i.add(n):(i.clear(),i.add(n)),{selectedCellIds:i}})},selectCellsInRange:n=>{e(r=>{const o=new Set(r.selectedCellIds);return n.forEach(i=>o.add(i)),{selectedCellIds:o}})},deselectCell:n=>{e(r=>{const o=new Set(r.selectedCellIds);return o.delete(n),{selectedCellIds:o}})},clearSelection:()=>{e({selectedCellIds:new Set})},toggleCellSelection:n=>{e(r=>{const o=new Set(r.selectedCellIds);return o.has(n)?o.delete(n):o.add(n),{selectedCellIds:o}})},startDragSelection:(n,r)=>{e({isDragSelecting:!0,dragStartPoint:{x:n,y:r},dragEndPoint:{x:n,y:r}})},updateDragSelection:(n,r)=>{e(()=>({dragEndPoint:{x:n,y:r}}))},endDragSelection:()=>{e({isDragSelecting:!1,dragStartPoint:null,dragEndPoint:null})},isSelected:n=>t().selectedCellIds.has(n),getSelectedCount:()=>t().selectedCellIds.size,getSelectedCells:()=>Array.from(t().selectedCellIds)})),qt=({text:e,textStyle:t,fontSize:n,onChange:r,onBlur:o,onKeyDown:i})=>{const s=g.useRef(null);return g.useEffect(()=>{if(s.current){const a=s.current,c=e.length;a.focus(),setTimeout(()=>{a.setSelectionRange(c,c)},0)}},[]),k.jsx("textarea",{ref:s,value:e,onChange:a=>r(a.target.value),onBlur:o,onKeyDown:i,"data-editing":"true",className:"w-full h-full bg-transparent border-none outline-none resize-none",style:{color:t.color,fontFamily:t.fontFamily,fontSize:`${n}px`,fontWeight:t.bold?"bold":"normal",fontStyle:t.italic?"italic":"normal",textAlign:t.horizontalAlign,lineHeight:"1.2",wordBreak:"break-word",cursor:"text"}})},lt=({onPointerDown:e,objectId:t})=>k.jsxs(k.Fragment,{children:[k.jsx("div",{className:"absolute w-3 h-3 bg-blue-600 border-2 border-white rounded-sm cursor-nw-resize shadow-md",style:{left:-6,top:-6},onPointerDown:n=>e(n,"nw",t)}),k.jsx("div",{className:"absolute w-3 h-3 bg-blue-600 border-2 border-white rounded-sm cursor-ne-resize shadow-md",style:{right:-6,top:-6},onPointerDown:n=>e(n,"ne",t)}),k.jsx("div",{className:"absolute w-3 h-3 bg-blue-600 border-2 border-white rounded-sm cursor-sw-resize shadow-md",style:{left:-6,bottom:-6},onPointerDown:n=>e(n,"sw",t)}),k.jsx("div",{className:"absolute w-3 h-3 bg-blue-600 border-2 border-white rounded-sm cursor-se-resize shadow-md",style:{right:-6,bottom:-6},onPointerDown:n=>e(n,"se",t)}),k.jsx("div",{className:"absolute w-3 h-3 bg-blue-600 border-2 border-white rounded-sm cursor-n-resize shadow-md",style:{left:"50%",top:-6,transform:"translateX(-50%)"},onPointerDown:n=>e(n,"n",t)}),k.jsx("div",{className:"absolute w-3 h-3 bg-blue-600 border-2 border-white rounded-sm cursor-s-resize shadow-md",style:{left:"50%",bottom:-6,transform:"translateX(-50%)"},onPointerDown:n=>e(n,"s",t)}),k.jsx("div",{className:"absolute w-3 h-3 bg-blue-600 border-2 border-white rounded-sm cursor-w-resize shadow-md",style:{left:-6,top:"50%",transform:"translateY(-50%)"},onPointerDown:n=>e(n,"w",t)}),k.jsx("div",{className:"absolute w-3 h-3 bg-blue-600 border-2 border-white rounded-sm cursor-e-resize shadow-md",style:{right:-6,top:"50%",transform:"translateY(-50%)"},onPointerDown:n=>e(n,"e",t)})]}),Jt=({obj:e,isSelected:t,isHovered:n,isViewPage:r,isDragging:o,currentX:i,currentY:s,currentWidth:a,currentHeight:c,currentTool:l,editingObjectId:p,editingText:m,onTextBoxClick:w,onObjectClick:d,onPointerDown:h,onResizePointerDown:O,onMouseEnter:W,onMouseLeave:N,onEditingTextChange:C,onFinishEdit:M,onKeyDown:Y,updateTextObject:$})=>{var v,L;const{defaultCheckedColor:G,defaultUncheckedColor:b,checkedBackgroundColor:te,uncheckedBackgroundColor:ne,checkedBackgroundOpacity:Z,uncheckedBackgroundOpacity:q}=Zt(),X=e.cellType==="cell"&&pe.getState().isSelected(e.id),_=e.boxStyle||{backgroundColor:"transparent",backgroundOpacity:1,borderColor:"#000000",borderWidth:0,borderRadius:0},D=e.textStyle||{color:"#000000",bold:!1,italic:!1,horizontalAlign:"left",verticalAlign:"middle",fontFamily:"Arial"},T=z=>{z.stopPropagation();const j=!e.checkboxChecked;$(e.id,{checkboxChecked:j,checkboxCheckedColor:e.checkboxCheckedColor||G,checkboxUncheckedColor:e.checkboxUncheckedColor||b})},P=z=>{z.stopPropagation()};return k.jsxs("div",{className:`absolute select-none ${t?"ring-4 ring-blue-600":n?"ring-2 ring-gray-400":""}`,style:{left:i,top:s,width:a,height:c,opacity:e.opacity,zIndex:e.zIndex||0,cursor:p===e.id?"text":r?"default":o?"grabbing":(v=e.permissions)!=null&&v.movable?"grab":"default",border:`${_.borderWidth}px solid ${_.borderColor}`,borderRadius:`${_.borderRadius}px`,transition:o?"none":"all 0.1s ease",pointerEvents:l==="pen"||l==="eraser"?"none":"auto"},onClick:z=>{o?d(z,e.id):w(e,z)},onPointerDown:z=>h(z,e.id),onMouseEnter:W,onMouseLeave:N,children:[k.jsx("div",{className:"absolute inset-0",style:{backgroundColor:X?"#9ca3af":e.hasCheckbox&&e.checkboxChecked?e.checkedBackgroundColor||te:e.hasCheckbox&&!e.checkboxChecked?e.uncheckedBackgroundColor||ne:_.backgroundColor,opacity:X?.15:e.hasCheckbox&&e.checkboxChecked?e.checkedBackgroundOpacity??Z:e.hasCheckbox&&!e.checkboxChecked?e.uncheckedBackgroundOpacity??q:_.backgroundOpacity,borderRadius:`${_.borderRadius}px`}}),k.jsx("div",{className:"relative z-10 h-full flex items-center",style:{justifyContent:D.horizontalAlign==="left"?"flex-start":D.horizontalAlign==="center"?"center":"flex-end",alignItems:D.verticalAlign==="top"?"flex-start":D.verticalAlign==="middle"?"center":"flex-end",padding:"8px"},children:p===e.id?k.jsx(qt,{text:m,textStyle:D,fontSize:e.fontSize||16,onChange:C,onBlur:M,onKeyDown:Y}):k.jsxs("div",{style:{color:D.color,fontFamily:D.fontFamily,fontSize:`${e.fontSize||16}px`,fontWeight:D.bold?"bold":"normal",fontStyle:D.italic?"italic":"normal",textAlign:D.horizontalAlign,lineHeight:"1.2",wordBreak:"break-word",cursor:"pointer",display:"flex",alignItems:D.verticalAlign==="top"?"flex-start":D.verticalAlign==="middle"?"center":"flex-end",width:"100%",height:"100%"},children:[e.hasCheckbox&&k.jsx("div",{className:"checkbox-area",onClick:T,onPointerDown:P,style:{display:"inline-flex",alignItems:"center",justifyContent:"center",width:"35px",height:"35px",backgroundColor:e.checkboxChecked?e.checkboxCheckedColor||G:e.checkboxUncheckedColor||b,border:`2px solid ${e.checkboxChecked?e.checkboxCheckedColor||G:"#d1d5db"}`,borderRadius:"4px",marginRight:"8px",transition:"all 0.2s ease",userSelect:"none",flexShrink:0,pointerEvents:"auto",cursor:"pointer"},children:e.checkboxChecked&&k.jsx("svg",{className:"checkbox-area",width:"16",height:"16",viewBox:"0 0 16 16",fill:"none",xmlns:"http://www.w3.org/2000/svg",children:k.jsx("path",{className:"checkbox-area",d:"M13.5 4.5L6 12L2.5 8.5",stroke:"white",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round"})})}),k.jsx("span",{style:{flex:1},children:e.text})]})}),t&&!r&&((L=e.permissions)==null?void 0:L.resizable)&&k.jsx(lt,{onPointerDown:O,objectId:e.id})]})},Qt=({obj:e,isSelected:t,isHovered:n,isViewPage:r,isDragging:o,currentX:i,currentY:s,currentWidth:a,currentHeight:c,currentTool:l,editingObjectId:p,onObjectClick:m,onPointerDown:w,onResizePointerDown:d,onMouseEnter:h,onMouseLeave:O})=>{var W,N;return k.jsxs("div",{className:`absolute select-none ${t?"ring-4 ring-blue-600":n?"ring-2 ring-gray-400":""}`,style:{left:i,top:s,width:a,height:c,opacity:e.opacity,zIndex:e.zIndex||0,cursor:p===e.id?"text":r?"default":o?"grabbing":(W=e.permissions)!=null&&W.movable?"grab":"default",transition:o?"none":"all 0.1s ease",pointerEvents:l==="pen"||l==="eraser"?"none":"auto"},onClick:C=>m(C,e.id),onPointerDown:C=>w(C,e.id),onMouseEnter:h,onMouseLeave:O,children:[k.jsx("img",{src:e.src,alt:"",className:`w-full h-full ${e.maintainAspectRatio?"object-contain":"object-fill"}`,draggable:!1,style:{pointerEvents:"none"}}),t&&!r&&((N=e.permissions)==null?void 0:N.resizable)&&k.jsx(lt,{onPointerDown:d,objectId:e.id})]})},Ne={isDragging:!1,draggedObjectId:null,offset:{x:0,y:0},currentPosition:{x:0,y:0}},en=()=>{const[e,t]=g.useState(Ne),n=g.useCallback((s,a,c)=>{t({isDragging:!0,draggedObjectId:s,offset:a,currentPosition:c})},[]),r=g.useCallback(s=>{t(a=>({...a,currentPosition:s}))},[]),o=g.useCallback(()=>{t(Ne)},[]),i=g.useCallback(s=>e.isDragging&&e.draggedObjectId===s,[e.isDragging,e.draggedObjectId]);return{dragState:e,startDrag:n,updateDragPosition:r,endDrag:o,isDraggingObject:i}},Ue={isResizing:!1,resizedObjectId:null,resizeHandle:null,startPosition:{x:0,y:0},startSize:{width:0,height:0},startObjectPosition:{x:0,y:0}},tn=()=>{const[e,t]=g.useState(Ue),n=g.useCallback((s,a,c,l,p)=>{t({isResizing:!0,resizedObjectId:s,resizeHandle:a,startPosition:c,startSize:l,startObjectPosition:p})},[]),r=g.useCallback((s,a)=>{t(c=>({...c,currentSize:s,currentPosition:a}))},[]),o=g.useCallback(()=>{t(Ue)},[]),i=g.useCallback(s=>e.isResizing&&e.resizedObjectId===s,[e.isResizing,e.resizedObjectId]);return{resizeState:e,startResize:n,updateResize:r,endResize:o,isResizingObject:i}},nn=(e,t,n=!1)=>{const[r,o]=g.useState(null),[i,s]=g.useState(""),a=g.useCallback(m=>{o(m.id),s(m.text),e(m.id,{isEditing:!0}),n?(t(m.id),setTimeout(()=>{window.dispatchEvent(new CustomEvent("activateVirtualKeyboard",{detail:{objectId:m.id}}))},100)):setTimeout(()=>{const w=document.querySelector('textarea[data-editing="true"]');if(w){const d=m.text.length;w.setSelectionRange(d,d),w.focus()}},0)},[n,e,t]),c=g.useCallback(async()=>{r&&i!==void 0&&(await e(r,{text:i,isEditing:!1}),o(null),s(""))},[r,i,e]),l=g.useCallback(()=>{o(null),s("")},[]),p=g.useCallback(m=>{s(m)},[]);return{editingObjectId:r,editingText:i,startInlineEdit:a,finishInlineEdit:c,cancelInlineEdit:l,updateEditingText:p}},rn=()=>{const e=g.useRef(!1),t=g.useRef(0);g.useEffect(()=>{const i=navigator.userAgent.toLowerCase(),s=/iphone|ipad|ipod/.test(i),a=/safari/.test(i)&&!/chrome/.test(i);e.current=s||a},[]);const n=i=>{t.current=i},r=i=>e.current&&i-t.current<300,o=()=>{const i=navigator.userAgent.toLowerCase();return/iphone/.test(i)};return{isSafari:e.current,updatePointerEventTime:n,isGhostClick:r,isIPhone:o}},on=(e,t)=>{var r;return{handleClipboardPaste:g.useCallback(async()=>{try{if(!navigator.clipboard||!navigator.clipboard.read){console.warn("클립보드 API가 지원되지 않습니다.");return}const o=await navigator.clipboard.read();for(const i of o){const s=i.types.filter(a=>a.startsWith("image/"));if(s.length>0){const a=s[0],c=await i.getType(a),l=new FileReader;l.onload=async p=>{var h,O;const m=(h=p.target)==null?void 0:h.result,w=((O=t==null?void 0:t.admin)==null?void 0:O.objectCreationPosition)??{x:260,y:950},d=new Image;d.onload=async()=>{try{const C=200*(d.naturalHeight/d.naturalWidth),M={x:w.x,y:w.y,width:200,height:C,src:m,permissions:{editable:!0,movable:!0,resizable:!0,deletable:!0},zIndex:Date.now(),locked:!1,visible:!0,opacity:1,maintainAspectRatio:!0,lastModified:Date.now()};await e(M),console.log("클립보드 이미지가 성공적으로 붙여넣어졌습니다.")}catch(W){console.error("이미지 객체 생성 실패:",W)}},d.onerror=()=>{console.error("클립보드 이미지 로드 실패")},d.src=m},l.onerror=()=>{console.error("클립보드 이미지 읽기 실패")},l.readAsDataURL(c);break}}}catch(o){console.log("클립보드에서 이미지를 읽을 수 없습니다:",o)}},[(r=t==null?void 0:t.admin)==null?void 0:r.objectCreationPosition,e])}},sn=(e,t,n,r,o,i,s,a)=>{const c=g.useCallback(async m=>{if(!m)return;const w=e.find(h=>h.id===m);if(w){const h={...w,x:w.x+20,y:w.y+20,isEditing:!1};delete h.id,await o(h);return}const d=t.find(h=>h.id===m);if(d){const h={...d,x:d.x+20,y:d.y+20};delete h.id,await i(h);return}},[e,t,o,i]),l=g.useCallback(async m=>{var h,O;if(!m)return;const w=e.find(W=>W.id===m);if(w&&((h=w.permissions)!=null&&h.deletable)){await n(m),a(null);return}const d=t.find(W=>W.id===m);if(d&&((O=d.permissions)!=null&&O.deletable)){await r(m),a(null);return}},[e,t,n,r,a]),p=g.useCallback(async()=>{const{getSelectedCells:m}=pe.getState(),w=m();if(w.length!==0)try{for(const d of w){const h=e.find(O=>O.id===d);h&&h.cellType==="cell"&&await s(d,{text:""})}console.log(`${w.length}개 셀의 텍스트 내용이 삭제되었습니다.`)}catch(d){console.error("셀 텍스트 일괄 삭제 실패:",d)}},[e,s]);return{handleDuplicateObject:c,handleDeleteObject:l,handleBulkClearCellText:p}},Ie=(e,t)=>Math.round(e/t)*t,an=(e,t,n)=>({x:Ie(e,n),y:Ie(t,n)}),cn=(e,t,n,r=50,o=30)=>({width:Math.max(Ie(e,n),r),height:Math.max(Ie(t,n),o)}),ut=e=>{const t=window.getComputedStyle(e).transform;let n=1;if(t&&t!=="none"){const r=t.match(/matrix\(([^)]+)\)/);r&&(n=r[1].split(",").map(i=>parseFloat(i.trim()))[0])}return n},We=(e,t,n)=>{const r=n.getBoundingClientRect(),o=ut(n);return{x:(e-r.left)/o,y:(t-r.top)/o}},Ge=(e,t,n,r)=>{if(!n)return{position:e,size:t};const o=an(e.x,e.y,r),i=t?cn(t.width,t.height,r):void 0;return{position:o,size:i}},ln=(e,t,n)=>({x:e.x-t.x/n,y:e.y-t.y/n}),un=(e,t)=>({x:e.x-t.x,y:e.y-t.y}),Ke=(e,t,n,r)=>{const o=Xt(e)?e:n||{x:0,y:0},i=t&&Nt(t)?t:r;return{position:o,size:i}},dn=e=>{const{handle:t,deltaX:n,deltaY:r,startSize:o,startPosition:i,maintainAspectRatio:s=!1,originalAspectRatio:a=1}=e;let c=o.width,l=o.height,p=i.x,m=i.y;switch(t){case"nw":c=Math.max(50,o.width-n),l=s?c/a:Math.max(30,o.height-r),p=i.x+(o.width-c),m=i.y+(o.height-l);break;case"ne":c=Math.max(50,o.width+n),l=s?c/a:Math.max(30,o.height-r),m=i.y+(o.height-l);break;case"sw":c=Math.max(50,o.width-n),l=s?c/a:Math.max(30,o.height+r),p=i.x+(o.width-c);break;case"se":c=Math.max(50,o.width+n),l=s?c/a:Math.max(30,o.height+r);break;case"n":s?(l=Math.max(30,o.height-r),c=l*a,p=i.x+(o.width-c)/2):l=Math.max(30,o.height-r),m=i.y+(o.height-l);break;case"s":s?(l=Math.max(30,o.height+r),c=l*a,p=i.x+(o.width-c)/2):l=Math.max(30,o.height+r);break;case"w":s?(c=Math.max(50,o.width-n),l=c/a,m=i.y+(o.height-l)/2):c=Math.max(50,o.width-n),p=i.x+(o.width-c);break;case"e":s?(c=Math.max(50,o.width+n),l=c/a,m=i.y+(o.height-l)/2):c=Math.max(50,o.width+n);break}return{newWidth:c,newHeight:l,newX:p,newY:m}},fn=e=>{try{e.preventDefault(),e.stopPropagation()}catch(t){console.debug("preventDefault failed in context menu handler:",t)}return!1},hn=(e,t,n)=>{if(e.key==="Enter"&&!e.shiftKey){try{e.preventDefault()}catch(r){console.debug("preventDefault failed in keydown handler:",r)}t()}else if(e.key==="Escape"){try{e.preventDefault()}catch(r){console.debug("preventDefault failed in keydown handler:",r)}n()}},gn=(e,t,n)=>{if(!e.cellPosition||!t.cellPosition||e.groupId!==t.groupId)return[];const r=Math.min(e.cellPosition.row,t.cellPosition.row),o=Math.max(e.cellPosition.row,t.cellPosition.row),i=Math.min(e.cellPosition.col,t.cellPosition.col),s=Math.max(e.cellPosition.col,t.cellPosition.col),a=[];return n.forEach(c=>{if(c.cellType==="cell"&&c.cellPosition&&c.groupId===e.groupId){const{row:l,col:p}=c.cellPosition;l>=r&&l<=o&&p>=i&&p<=s&&a.push(c.id)}}),a},Ve=(e,t,n)=>{if(n==="set")if(t)setTimeout(()=>{try{e.currentTarget.setPointerCapture(e.pointerId)}catch{console.debug("iPhone pointer capture failed, continuing without capture")}},0);else try{e.currentTarget.setPointerCapture(e.pointerId)}catch{}else try{e.currentTarget.releasePointerCapture(e.pointerId)}catch{}},pn=({isViewPage:e=!1})=>{const{textObjects:t,imageObjects:n,updateTextObject:r,updateImageObject:o,deleteTextObject:i,deleteImageObject:s,addTextObject:a,addImageObject:c,settings:l}=je(),{selectedObjectId:p,hoveredObjectId:m,currentTool:w,setSelectedObjectId:d,setHoveredObjectId:h}=$e(),{updatePointerEventTime:O,isGhostClick:W,isIPhone:N}=rn(),{dragState:C,startDrag:M,updateDragPosition:Y,endDrag:$,isDraggingObject:G}=en(),{resizeState:b,startResize:te,updateResize:ne,endResize:Z,isResizingObject:q}=tn(),{editingObjectId:X,editingText:_,startInlineEdit:D,finishInlineEdit:T,cancelInlineEdit:P,updateEditingText:v}=nn(r,d,e),{handleClipboardPaste:L}=on(c,l),{handleDuplicateObject:z,handleDeleteObject:j,handleBulkClearCellText:ie}=sn(t,n,i,s,a,c,r,d),[J,u]=g.useState({clickCount:0,clickTimer:null}),x=g.useCallback(f=>{if(!X){if(f.ctrlKey&&f.key==="v"){try{f.preventDefault()}catch(A){console.debug("preventDefault failed in global keydown handler:",A)}L();return}if(!e){if(f.ctrlKey&&f.key==="d"){try{f.preventDefault()}catch(A){console.debug("preventDefault failed in global keydown handler:",A)}p&&z(p)}if(f.key==="Delete"){try{f.preventDefault()}catch(B){console.debug("preventDefault failed in global keydown handler:",B)}if(pe.getState().getSelectedCells().length>0){ie();return}p&&j(p)}}}},[X,p,e,z,j,L,ie]),y=g.useCallback((f,A)=>{var V;O(f.timeStamp),f.stopPropagation();const B=N();if((!B||f.pointerType!=="touch")&&f.preventDefault(),X){T();return}const H=t.find(re=>re.id===A)||n.find(re=>re.id===A);if(!H||(d(A),h(null),!((V=H.permissions)!=null&&V.movable)))return;Ve(f,B,"set");const F=f.currentTarget.getBoundingClientRect(),U={x:f.clientX-F.left,y:f.clientY-F.top};M(A,U,{x:H.x,y:H.y})},[X,T,t,n,d,h,O,N,M]),S=g.useCallback((f,A,B)=>{var F;f.stopPropagation(),f.preventDefault();const H=t.find(U=>U.id===B)||n.find(U=>U.id===B);!H||!((F=H.permissions)!=null&&F.resizable)||te(B,A,{x:f.clientX,y:f.clientY},{width:H.width,height:H.height},{x:H.x,y:H.y})},[t,n,te]),R=g.useCallback(f=>{var A,B,H,F;if(C.isDragging&&C.draggedObjectId){const U=f.currentTarget.closest("[data-canvas-container]");if(!U)return;const V=We(f.clientX,f.clientY,U),re=ut(U),ue=ln(V,C.offset,re),se=((A=l==null?void 0:l.admin)==null?void 0:A.gridSnapEnabled)??!1,he=((B=l==null?void 0:l.admin)==null?void 0:B.gridSize)??32,{position:de}=Ge(ue,void 0,se,he),oe=t.find(ye=>ye.id===C.draggedObjectId)||n.find(ye=>ye.id===C.draggedObjectId),{position:ge}=Ke(de,void 0,oe?{x:oe.x,y:oe.y}:void 0);Y(ge)}if(b.isResizing&&b.resizedObjectId){const U=f.currentTarget.closest("[data-canvas-container]");if(!U)return;const V=We(f.clientX,f.clientY,U),re=We(b.startPosition.x,b.startPosition.y,U),ue=un(V,re),se=n.find(pt=>pt.id===b.resizedObjectId),he=(se==null?void 0:se.maintainAspectRatio)||!1,de=se?b.startSize.width/b.startSize.height:1,oe=dn({handle:b.resizeHandle,deltaX:ue.x,deltaY:ue.y,startSize:b.startSize,startPosition:b.startObjectPosition,maintainAspectRatio:he,originalAspectRatio:de}),ge=((H=l==null?void 0:l.admin)==null?void 0:H.gridSnapEnabled)??!1,ye=((F=l==null?void 0:l.admin)==null?void 0:F.gridSize)??32,{position:ht,size:gt}=Ge({x:oe.newX,y:oe.newY},{width:oe.newWidth,height:oe.newHeight},ge,ye),Me=Ke(ht,gt);Me.size&&ne(Me.size,Me.position)}},[C,b,t,n,l,Y,ne]),E=g.useCallback(f=>{if(Ve(f,N(),"release"),C.isDragging&&C.draggedObjectId){const A=C.currentPosition,B=t.find(F=>F.id===C.draggedObjectId),H=n.find(F=>F.id===C.draggedObjectId);B?r(C.draggedObjectId,A).catch(F=>{console.error("Failed to update text object position:",F)}):H&&o(C.draggedObjectId,A).catch(F=>{console.error("Failed to update image object position:",F)}),$()}if(b.isResizing&&b.resizedObjectId){const A=b.currentSize,B=b.currentPosition;if(A&&B){const H=t.find(V=>V.id===b.resizedObjectId),F=n.find(V=>V.id===b.resizedObjectId),U={x:B.x,y:B.y,width:A.width,height:A.height};H?r(b.resizedObjectId,U).catch(V=>{console.error("Failed to update text object size/position:",V)}):F&&o(b.resizedObjectId,U).catch(V=>{console.error("Failed to update image object size/position:",V)})}Z()}},[C,b,t,n,r,o,$,Z,N]),I=g.useCallback((f,A)=>{if(W(f.timeStamp))return;const B=t.find(F=>F.id===A),H=(B==null?void 0:B.cellType)==="cell";if(!e&&w==="select"&&!H){const{clearSelection:F}=pe.getState();F(),d(A),f&&f.stopPropagation()}},[w,e,d,t,W]),K=g.useCallback(f=>{if(W(f.timeStamp))return;if(f.currentTarget.focus(),X){T();return}if(!e&&w==="select"){if(f.target===f.currentTarget){d(null);const{clearSelection:B}=pe.getState();B()}}else if(e&&f.target===f.currentTarget){d(null);const{clearSelection:B}=pe.getState();B()}},[X,T,d,e,w,W]),fe=g.useCallback((f,A)=>{if(w!=="select")return;if(X&&X!==f.id&&T(),f.cellType==="cell"){const{selectCell:F,selectCellsInRange:U,getSelectedCells:V}=pe.getState(),re=J.clickCount+1;if(J.clickTimer&&clearTimeout(J.clickTimer),re===2)D(f),u({clickCount:0,clickTimer:null});else{const ue=A.ctrlKey||A.metaKey,se=A.shiftKey;if(se){const de=V();if(de.length>0){const oe=t.find(ge=>ge.id===de[de.length-1]);if(oe&&oe.cellType==="cell"&&oe.cellPosition&&f.cellPosition){const ge=gn(oe,f,t);U(ge)}}else F(f.id,!1)}else ue?F(f.id,!0):F(f.id,!1);!ue&&!se&&d(null);const he=setTimeout(()=>{u({clickCount:0,clickTimer:null})},300);u({clickCount:re,clickTimer:he})}return}const H=J.clickCount+1;if(J.clickTimer&&clearTimeout(J.clickTimer),H===3)D(f),u({clickCount:0,clickTimer:null});else{I(A,f.id);const F=setTimeout(()=>{u({clickCount:0,clickTimer:null})},500);u({clickCount:H,clickTimer:F})}},[w,X,T,D,J,t,d,I]);return k.jsx("div",{className:"absolute inset-0",tabIndex:0,onClick:K,onKeyDown:x,onPointerMove:R,onPointerUp:E,onPointerLeave:E,onContextMenu:fn,style:{touchAction:"none",pointerEvents:"auto",outline:"none"},children:[...t,...n].sort((f,A)=>(f.zIndex||0)-(A.zIndex||0)).map(f=>{const A="text"in f,B="src"in f,H=G(f.id),F=q(f.id),U=H?C.currentPosition.x:F&&b.currentPosition?b.currentPosition.x:f.x,V=H?C.currentPosition.y:F&&b.currentPosition?b.currentPosition.y:f.y,re=F&&b.currentSize?b.currentSize.width:f.width,ue=F&&b.currentSize?b.currentSize.height:f.height,se=p===f.id,he=m===f.id&&!e;return A?k.jsx(Jt,{obj:f,isSelected:se,isHovered:he,isViewPage:e,isDragging:H,isResizing:F,currentX:U,currentY:V,currentWidth:re,currentHeight:ue,currentTool:w,editingObjectId:X,editingText:_,onTextBoxClick:fe,onObjectClick:I,onPointerDown:y,onResizePointerDown:S,onMouseEnter:()=>h(f.id),onMouseLeave:()=>h(null),onEditingTextChange:v,onFinishEdit:T,onKeyDown:de=>hn(de,T,P),updateTextObject:r},f.id):B?k.jsx(Qt,{obj:f,isSelected:se,isHovered:he,isViewPage:e,isDragging:H,currentX:U,currentY:V,currentWidth:re,currentHeight:ue,currentTool:w,editingObjectId:X,onObjectClick:I,onPointerDown:y,onResizePointerDown:S,onMouseEnter:()=>h(f.id),onMouseLeave:()=>h(null)},f.id):null})})},mn=({isViewPage:e=!1})=>null;function Ze(e,t,n,r=o=>o){return e*r(.5-t*(.5-n))}function bn(e){return[-e[0],-e[1]]}function le(e,t){return[e[0]+t[0],e[1]+t[1]]}function ae(e,t){return[e[0]-t[0],e[1]-t[1]]}function ce(e,t){return[e[0]*t,e[1]*t]}function wn(e,t){return[e[0]/t,e[1]/t]}function Ce(e){return[e[1],-e[0]]}function qe(e,t){return e[0]*t[0]+e[1]*t[1]}function xn(e,t){return e[0]===t[0]&&e[1]===t[1]}function yn(e){return Math.hypot(e[0],e[1])}function vn(e){return e[0]*e[0]+e[1]*e[1]}function Je(e,t){return vn(ae(e,t))}function dt(e){return wn(e,yn(e))}function Cn(e,t){return Math.hypot(e[1]-t[1],e[0]-t[0])}function ke(e,t,n){let r=Math.sin(n),o=Math.cos(n),i=e[0]-t[0],s=e[1]-t[1],a=i*o-s*r,c=i*r+s*o;return[a+t[0],c+t[1]]}function Fe(e,t,n){return le(e,ce(ae(t,e),n))}function Qe(e,t,n){return le(e,ce(t,n))}var{min:we,PI:kn}=Math,et=.275,Se=kn+1e-4;function Sn(e,t={}){let{size:n=16,smoothing:r=.5,thinning:o=.5,simulatePressure:i=!0,easing:s=v=>v,start:a={},end:c={},last:l=!1}=t,{cap:p=!0,easing:m=v=>v*(2-v)}=a,{cap:w=!0,easing:d=v=>--v*v*v+1}=c;if(e.length===0||n<=0)return[];let h=e[e.length-1].runningLength,O=a.taper===!1?0:a.taper===!0?Math.max(n,h):a.taper,W=c.taper===!1?0:c.taper===!0?Math.max(n,h):c.taper,N=Math.pow(n*r,2),C=[],M=[],Y=e.slice(0,10).reduce((v,L)=>{let z=L.pressure;if(i){let j=we(1,L.distance/n),ie=we(1,1-j);z=we(1,v+(ie-v)*(j*et))}return(v+z)/2},e[0].pressure),$=Ze(n,o,e[e.length-1].pressure,s),G,b=e[0].vector,te=e[0].point,ne=te,Z=te,q=ne,X=!1;for(let v=0;v<e.length;v++){let{pressure:L}=e[v],{point:z,vector:j,distance:ie,runningLength:J}=e[v];if(v<e.length-1&&h-J<3)continue;if(o){if(i){let K=we(1,ie/n),fe=we(1,1-K);L=we(1,Y+(fe-Y)*(K*et))}$=Ze(n,o,L,s)}else $=n/2;G===void 0&&(G=$);let u=J<O?m(J/O):1,x=h-J<W?d((h-J)/W):1;$=Math.max(.01,$*Math.min(u,x));let y=(v<e.length-1?e[v+1]:e[v]).vector,S=v<e.length-1?qe(j,y):1,R=qe(j,b)<0&&!X,E=S!==null&&S<0;if(R||E){let K=ce(Ce(b),$);for(let fe=1/13,f=0;f<=1;f+=fe)Z=ke(ae(z,K),z,Se*f),C.push(Z),q=ke(le(z,K),z,Se*-f),M.push(q);te=Z,ne=q,E&&(X=!0);continue}if(X=!1,v===e.length-1){let K=ce(Ce(j),$);C.push(ae(z,K)),M.push(le(z,K));continue}let I=ce(Ce(Fe(y,j,S)),$);Z=ae(z,I),(v<=1||Je(te,Z)>N)&&(C.push(Z),te=Z),q=le(z,I),(v<=1||Je(ne,q)>N)&&(M.push(q),ne=q),Y=L,b=j}let _=e[0].point.slice(0,2),D=e.length>1?e[e.length-1].point.slice(0,2):le(e[0].point,[1,1]),T=[],P=[];if(e.length===1){if(!(O||W)||l){let v=Qe(_,dt(Ce(ae(_,D))),-(G||$)),L=[];for(let z=1/13,j=z;j<=1;j+=z)L.push(ke(v,_,Se*2*j));return L}}else{if(!(O||W&&e.length===1))if(p)for(let L=1/13,z=L;z<=1;z+=L){let j=ke(M[0],_,Se*z);T.push(j)}else{let L=ae(C[0],M[0]),z=ce(L,.5),j=ce(L,.51);T.push(ae(_,z),ae(_,j),le(_,j),le(_,z))}let v=Ce(bn(e[e.length-1].vector));if(W||O&&e.length===1)P.push(D);else if(w){let L=Qe(D,v,$);for(let z=1/29,j=z;j<1;j+=z)P.push(ke(L,D,Se*3*j))}else P.push(le(D,ce(v,$)),le(D,ce(v,$*.99)),ae(D,ce(v,$*.99)),ae(D,ce(v,$)))}return C.concat(P,M.reverse(),T)}function zn(e,t={}){var n;let{streamline:r=.5,size:o=16,last:i=!1}=t;if(e.length===0)return[];let s=.15+(1-r)*.85,a=Array.isArray(e[0])?e:e.map(({x:d,y:h,pressure:O=.5})=>[d,h,O]);if(a.length===2){let d=a[1];a=a.slice(0,-1);for(let h=1;h<5;h++)a.push(Fe(a[0],d,h/4))}a.length===1&&(a=[...a,[...le(a[0],[1,1]),...a[0].slice(2)]]);let c=[{point:[a[0][0],a[0][1]],pressure:a[0][2]>=0?a[0][2]:.25,vector:[1,1],distance:0,runningLength:0}],l=!1,p=0,m=c[0],w=a.length-1;for(let d=1;d<a.length;d++){let h=i&&d===w?a[d].slice(0,2):Fe(m.point,a[d],s);if(xn(m.point,h))continue;let O=Cn(h,m.point);if(p+=O,d<w&&!l){if(p<o)continue;l=!0}m={point:h,pressure:a[d][2]>=0?a[d][2]:.5,vector:dt(ae(m.point,h)),distance:O,runningLength:p},c.push(m)}return c[0].vector=((n=c[1])==null?void 0:n.vector)||[0,0],c}function tt(e,t={}){return Sn(zn(e,t),t)}const Pn=()=>{var J;const e=g.useRef(null),t=g.useRef(!1),n=g.useRef(null),r=g.useRef(!1),o=g.useRef(null),i=g.useRef(!1),s=g.useRef(null),a=g.useRef(!0),c=g.useRef(null),l=g.useRef(null),{currentStroke:p,currentPressureStroke:m,isDrawing:w,penColor:d,penWidth:h,usePerfectFreehand:O,addPoint:W,startStroke:N,endStroke:C,clearCurrentStroke:M}=_t(),{drawObjects:Y,settings:$,isLoading:G}=je(),{currentTool:b,setCurrentTool:te}=$e();g.useEffect(()=>{const u=navigator.userAgent.toLowerCase(),x=/iphone|ipad|ipod/.test(u),y=/safari/.test(u)&&!/chrome/.test(u);i.current=x||y},[]);const ne=g.useCallback((u="mouse")=>{const x={size:h*2,thinning:.5,smoothing:.5,streamline:.5,easing:y=>y,start:{taper:0,easing:y=>y,cap:!0},end:{taper:100,easing:y=>y,cap:!0}};return u==="pen"?{...x,thinning:.7,smoothing:.3,streamline:.3}:u==="touch"?{...x,thinning:.4,smoothing:.7,streamline:.7,size:h*2.5}:x},[h]),Z=g.useCallback((u,x,y)=>{if(x.length<2)return;u.save(),u.fillStyle=y,u.beginPath();const[S]=x;u.moveTo(S[0],S[1]);for(let R=1;R<x.length;R++){const[E,I]=x[R],[K,fe]=x[R-1],f=(K+E)/2,A=(fe+I)/2;u.quadraticCurveTo(K,fe,f,A)}u.closePath(),u.fill(),u.restore()},[]),q=g.useCallback(()=>{var u;n.current&&(clearTimeout(n.current),n.current=null),(u=$==null?void 0:$.admin)!=null&&u.autoToolSwitch&&(n.current=setTimeout(()=>{te("select"),n.current=null},2e3))},[(J=$==null?void 0:$.admin)==null?void 0:J.autoToolSwitch,te]),X=g.useCallback(()=>{const u=e.current;if(!u||!a.current)return;const x=u.parentElement;if(!x)return;const y=x.offsetWidth,S=x.offsetHeight;(u.width!==y||u.height!==S)&&(u.width=y,u.height=S,!r.current&&a.current&&(r.current=!0,l.current=requestAnimationFrame(()=>{r.current&&!G&&a.current&&(P(),r.current=!1),l.current=null})))},[G]),_=g.useCallback((u,x)=>{const y=e.current;if(!y)return{x:0,y:0};const S=y.getBoundingClientRect(),R=(u-S.left)/S.width*2160,E=(x-S.top)/S.height*3840;return{x:R,y:E}},[]),D=g.useCallback((u,x)=>{const y=e.current;return y?{x:u/2160*y.width,y:x/3840*y.height}:{x:0,y:0}},[]),T=g.useCallback(async(u,x)=>{for(const S of Y)for(let R=0;R<S.points.length;R+=2)if(Math.sqrt((S.points[R]-u)**2+(S.points[R+1]-x)**2)<=20)try{const I=Q(ee,`drawObjects/${S.id}`);await Ee(I);return}catch(I){console.error("❌ DrawLayer: Failed to erase stroke:",I)}},[Y]),P=g.useCallback(()=>{const u=e.current;if(!u)return;const x=u.getContext("2d");if(x&&!(u.width===0||u.height===0)&&(x.clearRect(0,0,u.width,u.height),x.lineCap="round",x.lineJoin="round",Y.forEach(y=>{var S;if(!(y.points.length<4))if(O&&y.usePerfectFreehand)try{const R=[];for(let E=0;E<y.points.length;E+=2){const I=D(y.points[E],y.points[E+1]);R.push([I.x,I.y,((S=y.pressure)==null?void 0:S[E/2])||.5])}if(R.length>=2){const E=ne(y.inputType||"mouse");E.size=y.width*2;const I=tt(R,E);Z(x,I,y.color)}}catch(R){console.warn("🚫 perfect-freehand 렌더링 실패, 기본 렌더링으로 대체:",R),x.beginPath(),x.strokeStyle=y.color,x.lineWidth=y.width;const E=D(y.points[0],y.points[1]);x.moveTo(E.x,E.y);for(let I=2;I<y.points.length;I+=2){const K=D(y.points[I],y.points[I+1]);x.lineTo(K.x,K.y)}x.stroke()}else{x.beginPath(),x.strokeStyle=y.color,x.lineWidth=y.width;const R=D(y.points[0],y.points[1]);x.moveTo(R.x,R.y);for(let E=2;E<y.points.length;E+=2){const I=D(y.points[E],y.points[E+1]);x.lineTo(I.x,I.y)}x.stroke()}}),w&&p.length>=4))if(O&&m.length>=2)try{const y=m.map(I=>{const K=D(I.x,I.y);return[K.x,K.y,I.pressure||.5]}),S=o.current&&i.current?"touch":"mouse",R=ne(S),E=tt(y,R);Z(x,E,d)}catch(y){console.warn("🚫 현재 스트로크 perfect-freehand 렌더링 실패:",y),x.beginPath(),x.strokeStyle=d,x.lineWidth=h;const S=D(p[0],p[1]);x.moveTo(S.x,S.y);for(let R=2;R<p.length;R+=2){const E=D(p[R],p[R+1]);x.lineTo(E.x,E.y)}x.stroke()}else{x.beginPath(),x.strokeStyle=d,x.lineWidth=h;const y=D(p[0],p[1]);x.moveTo(y.x,y.y);for(let S=2;S<p.length;S+=2){const R=D(p[S],p[S+1]);x.lineTo(R.x,R.y)}x.stroke()}},[Y,p,m,w,d,h,O,D,G,ne,Z]),v=g.useCallback(u=>{const x=navigator.userAgent.toLowerCase(),y=/iphone/.test(x),S=/ipad/.test(x);if(i.current){if(y)return!0;if(S&&(b==="eraser"&&o.current!==null&&u.pointerType==="touch"||b==="pen"&&u.pointerType!=="pen"&&u.pointerType!=="touch"&&u.pointerType!=="mouse"))return!1}return!0},[b]),L=g.useCallback(u=>{if(b!=="pen"&&b!=="eraser"||!v(u))return;const x=navigator.userAgent.toLowerCase(),y=/iphone/.test(x);if(!y&&o.current!==null&&o.current!==u.pointerId)return;(!y||u.pointerType!=="touch")&&u.preventDefault(),u.stopPropagation(),o.current=u.pointerId,n.current&&(clearTimeout(n.current),n.current=null),s.current&&(clearTimeout(s.current),s.current=null);const S=_(u.clientX,u.clientY);if(b==="pen"){N();const R=u.pressure||(y?.7:.5),E=u.tiltX||0,I=u.tiltY||0;W(S.x,S.y,R,E,I),P()}else b==="eraser"&&(t.current=!0,T(S.x,S.y))},[b,_,N,W,P,T,v]),z=g.useCallback(u=>{const x=navigator.userAgent.toLowerCase();if(!(!/iphone/.test(x)&&o.current!==u.pointerId)){if(b==="pen"&&w){u.preventDefault();const S=_(u.clientX,u.clientY),R=u.pressure||.5,E=u.tiltX||0,I=u.tiltY||0;W(S.x,S.y,R,E,I),P()}else if(b==="eraser"&&t.current){u.preventDefault();const S=_(u.clientX,u.clientY);T(S.x,S.y)}}},[w,b,_,W,P,T]),j=g.useCallback(async u=>{const x=navigator.userAgent.toLowerCase();if(!(!/iphone/.test(x)&&o.current!==u.pointerId)){if(w&&b==="pen"){if(C(),p.length>=4){const S=u.pointerType==="pen"?"pen":u.pointerType==="touch"?"touch":"mouse",R=m.map(I=>I.pressure||.5),E={points:p,color:d,width:h,createdAt:new Date().toISOString(),lastModified:Date.now(),usePerfectFreehand:O,pressure:R,inputType:S};try{await Vt(E)}catch(I){console.error("❌ DrawLayer: Failed to save stroke:",I)}}M(),P(),q()}b==="eraser"&&t.current&&(t.current=!1,q()),o.current=null,i.current&&u.pointerType==="touch"&&(s.current=setTimeout(()=>{s.current=null},100))}},[w,b,p,C,d,h,M,P,q]),ie=g.useCallback(u=>{o.current===u.pointerId&&(w&&(C(),M(),P()),t.current&&(t.current=!1),o.current=null)},[w,C,M,P]);return g.useEffect(()=>{X();const u=()=>{a.current&&setTimeout(X,100)};return window.addEventListener("resize",u),()=>{window.removeEventListener("resize",u),a.current=!1,l.current&&(cancelAnimationFrame(l.current),l.current=null),r.current=!1}},[X]),g.useEffect(()=>{if(!G&&a.current)return c.current=setTimeout(()=>{a.current&&P(),c.current=null},100),()=>{c.current&&(clearTimeout(c.current),c.current=null)}},[G]),g.useEffect(()=>{G||P()},[Y,G]),g.useEffect(()=>{(b==="pen"||b==="eraser")&&n.current&&(clearTimeout(n.current),n.current=null)},[b]),g.useEffect(()=>{w&&P()},[p,w]),g.useEffect(()=>()=>{a.current=!1,n.current&&(clearTimeout(n.current),n.current=null),s.current&&(clearTimeout(s.current),s.current=null),c.current&&(clearTimeout(c.current),c.current=null),l.current&&(cancelAnimationFrame(l.current),l.current=null),r.current=!1,o.current=null},[]),k.jsx("canvas",{ref:e,className:"absolute top-0 left-0 w-full h-full",onPointerDown:b==="pen"||b==="eraser"?L:void 0,onPointerMove:b==="pen"||b==="eraser"?z:void 0,onPointerUp:b==="pen"||b==="eraser"?j:void 0,onPointerCancel:b==="pen"||b==="eraser"?ie:void 0,onPointerLeave:b==="pen"||b==="eraser"?j:void 0,onContextMenu:u=>u.preventDefault(),style:{position:"absolute",top:0,left:0,width:"100%",height:"100%",touchAction:"none",cursor:b==="pen"?"crosshair":b==="eraser"?"grab":"default",pointerEvents:b==="pen"||b==="eraser"?"auto":"none",WebkitTouchCallout:"none",WebkitUserSelect:"none",WebkitTapHighlightColor:"transparent"}})},ft=Oe.memo(({gridEnabled:e,gridSize:t,canvasWidth:n,canvasHeight:r})=>{if(!e)return null;const o=[],i=[];for(let s=0;s<=n;s+=t)o.push(k.jsx("line",{x1:s,y1:0,x2:s,y2:r,stroke:"#e5e7eb",strokeWidth:1,opacity:.5},`v-${s}`));for(let s=0;s<=r;s+=t)i.push(k.jsx("line",{x1:0,y1:s,x2:n,y2:s,stroke:"#e5e7eb",strokeWidth:1,opacity:.5},`h-${s}`));return k.jsxs("svg",{className:"absolute inset-0 pointer-events-none",width:n,height:r,style:{zIndex:1},children:[o,i]})});ft.displayName="GridLayer";const On=e=>e.split(`
`).filter(t=>t.trim()).map(t=>t.split("	")),Dn=()=>{var w;const{settings:e}=je(),[t,n]=Oe.useState(""),[r,o]=Oe.useState(!1);if(Oe.useEffect(()=>{const d=h=>{n(h.detail.data),o(h.detail.show)};return window.addEventListener("excel-preview-update",d),()=>{window.removeEventListener("excel-preview-update",d)}},[]),!r||!t.trim())return null;const i={excelPasteSettings:((w=e==null?void 0:e.admin)==null?void 0:w.excelPasteSettings)??{startPosition:{x:100,y:100},cellWidth:120,cellHeight:40,fontSize:14}},s=On(t),{startPosition:a,cellWidth:c,cellHeight:l}=i.excelPasteSettings,p=Math.max(...s.map(d=>d.length))*c,m=s.length*l;return k.jsxs("div",{style:{position:"absolute",top:0,left:0,right:0,bottom:0,pointerEvents:"none",zIndex:15},children:[k.jsx("div",{style:{position:"absolute",left:a.x,top:a.y,width:p,height:m,border:"3px dashed #fbbf24",backgroundColor:"rgba(251, 191, 36, 0.1)",borderRadius:"4px",boxShadow:"0 2px 8px rgba(251, 191, 36, 0.3)"}}),s.map((d,h)=>d.map((O,W)=>k.jsx("div",{style:{position:"absolute",left:a.x+W*c,top:a.y+h*l,width:c,height:l,border:"1px solid rgba(251, 191, 36, 0.4)",backgroundColor:"rgba(251, 191, 36, 0.05)",display:"flex",alignItems:"center",justifyContent:"center",fontSize:`${i.excelPasteSettings.fontSize}px`,color:"rgba(251, 191, 36, 0.8)",fontWeight:"bold",overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap",padding:"2px"},children:O},`preview-${h}-${W}`))),k.jsxs("div",{style:{position:"absolute",left:a.x,top:a.y-30,backgroundColor:"rgba(251, 191, 36, 0.9)",color:"#ffffff",padding:"4px 8px",borderRadius:"4px",fontSize:"12px",fontWeight:"bold",whiteSpace:"nowrap",boxShadow:"0 2px 4px rgba(0, 0, 0, 0.2)"},children:["📊 미리보기: ",s.length,"행 × ",Math.max(...s.map(d=>d.length)),"열"]})]})},ze=2160,Pe=3840,In=({isViewPage:e=!1})=>{var q,X,_,D;const t=g.useRef(null),n=g.useRef(null),[r,o]=g.useState(.15),{zoom:i,viewOffset:s,setZoom:a,zoomAtPoint:c,currentTool:l}=$e(),{floorImage:p,settings:m}=je(),w={gridVisible:((q=m==null?void 0:m.admin)==null?void 0:q.gridVisible)??!0,gridSize:((X=m==null?void 0:m.admin)==null?void 0:X.gridSize)??32},d=g.useCallback(T=>{T.ctrlKey},[]);g.useEffect(()=>{i<.04&&a(1)},[i,a]),g.useEffect(()=>{const T=P=>{if(P.ctrlKey){try{P.preventDefault()}catch(ie){console.debug("preventDefault failed in global wheel handler:",ie)}if(!t.current||!n.current)return;const v=t.current.getBoundingClientRect(),L=P.clientX-v.left,z=P.clientY-v.top,j=-P.deltaY;c(j,L,z,v)}};return window.addEventListener("wheel",T,{passive:!1}),()=>{window.removeEventListener("wheel",T)}},[c]),g.useEffect(()=>{const T=P=>{if(P.ctrlKey&&(P.key==="+"||P.key==="=")){try{P.preventDefault()}catch(j){console.debug("preventDefault failed in global keydown handler:",j)}if(!t.current||!n.current)return;const v=t.current.getBoundingClientRect(),L=v.width/2,z=v.height/2;c(120,L,z,v)}if(P.ctrlKey&&P.key==="-"){try{P.preventDefault()}catch(j){console.debug("preventDefault failed in global keydown handler:",j)}if(!t.current||!n.current)return;const v=t.current.getBoundingClientRect(),L=v.width/2,z=v.height/2;c(-120,L,z,v)}};return window.addEventListener("keydown",T),()=>{window.removeEventListener("keydown",T)}},[c]),g.useEffect(()=>{const T=()=>{if(t.current){const v=t.current,L=v.clientWidth,z=v.clientHeight;if(L<=0||z<=0){o(.15);return}const j=L/ze,ie=z/Pe,J=Math.min(j,ie);o(Math.max(.1,J))}},P=setTimeout(T,100);return window.addEventListener("resize",T),()=>{clearTimeout(P),window.removeEventListener("resize",T)}},[i]);const h=r*i,O=ze*h,W=Pe*h,N=((_=t.current)==null?void 0:_.clientWidth)||0,C=((D=t.current)==null?void 0:D.clientHeight)||0,M=200,Y=O>N,$=W>C,G=Y?O+M*2:N,b=$?W+M*2:C,te=T=>{try{T.preventDefault(),T.stopPropagation()}catch(P){console.debug("preventDefault failed in Canvas context menu:",P)}return!1},ne=T=>{if(T.touches.length===1){const P=setTimeout(()=>{try{T.preventDefault()}catch{}},200),v=()=>{clearTimeout(P),document.removeEventListener("touchend",v),document.removeEventListener("touchmove",v)};document.addEventListener("touchend",v,{once:!0}),document.addEventListener("touchmove",v,{once:!0})}},Z=()=>l==="pen"||l==="eraser"?"crosshair":"default";return k.jsxs("div",{ref:t,onWheel:d,style:{position:"relative",width:"100%",height:"100%",overflowX:Y?"auto":"hidden",overflowY:$?"auto":"hidden",backgroundColor:"transparent",cursor:Z()},children:[(Y||$)&&k.jsx("div",{style:{position:"absolute",top:0,left:0,width:G,height:b,pointerEvents:"none",zIndex:1}}),k.jsxs("div",{ref:n,"data-canvas-container":!0,style:{position:"absolute",backgroundColor:"#ffffff",border:"1px solid #d1d5db",boxShadow:"0 4px 6px -1px rgba(0, 0, 0, 0.1)",width:ze,height:Pe,transform:`translate(${s.x}px, ${s.y}px) scale(${h})`,transformOrigin:"center center",left:Y||$?G/2:"50%",top:Y||$?b/2:"50%",marginLeft:`-${ze/2}px`,marginTop:`-${Pe/2}px`,zIndex:10},onContextMenu:te,onTouchStart:ne,children:[p?k.jsx("div",{style:{position:"absolute",top:0,left:0,right:0,bottom:0,backgroundImage:`url(${p.path})`,backgroundSize:"cover",backgroundPosition:"center",backgroundRepeat:"no-repeat",zIndex:0}}):k.jsx("div",{style:{position:"absolute",top:0,left:0,right:0,bottom:0,backgroundColor:"#f9fafb",display:"flex",alignItems:"center",justifyContent:"center",zIndex:0},children:k.jsxs("div",{style:{color:"#9ca3af",fontSize:"24px",textAlign:"center"},children:["Board7 Canvas",k.jsx("br",{}),k.jsx("span",{style:{fontSize:"16px"},children:"2160 x 3840"})]})}),k.jsxs("div",{style:{position:"absolute",top:0,left:0,right:0,bottom:0,zIndex:100},children:[k.jsx(ft,{gridEnabled:w.gridVisible,gridSize:w.gridSize,canvasWidth:ze,canvasHeight:Pe}),k.jsx(mn,{}),k.jsx(pn,{isViewPage:e}),k.jsx(Dn,{})]}),k.jsx("div",{style:{position:"absolute",top:0,left:0,right:0,bottom:0,zIndex:1e4,pointerEvents:l==="pen"||l==="eraser"?"auto":"none"},children:k.jsx(Pn,{isViewPage:e})})]}),k.jsxs("div",{style:{position:"absolute",bottom:"16px",left:"16px",backgroundColor:"rgba(0, 0, 0, 0.5)",color:"#ffffff",padding:"4px 12px",borderRadius:"4px",fontSize:"14px",zIndex:1e3},children:[Math.round(r*i*100),"%"]})]})};export{In as C,je as a,$e as b,_t as c,pe as u};
